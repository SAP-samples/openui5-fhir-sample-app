/*
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./Text","./Label","./ToolbarSpacer","./Column","./Button","./Dialog","./ColumnListItem","./Table","./Toolbar","sap/ui/base/ManagedObject","sap/ui/base/ManagedObjectRegistry","sap/base/Log","sap/m/library","sap/ui/Device","sap/ui/model/Sorter","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/m/CheckBox","sap/m/SearchField","sap/m/ScrollContainer","sap/ui/thirdparty/jquery"],function(t,e,o,i,n,s,a,l,r,h,u,c,p,d,g,_,m,f,I,b,S,C){"use strict";var T=p.ButtonType;var y=p.ListMode;var D=h.extend("sap.m.TablePersoDialog",{constructor:function(t,e){h.apply(this,arguments)},metadata:{properties:{contentWidth:{type:"sap.ui.core.CSSSize"},contentHeight:{type:"sap.ui.core.CSSSize",since:"1.22"},persoMap:{type:"object"},columnInfoCallback:{type:"object",since:"1.22"},initialColumnState:{type:"object",since:"1.22"},hasGrouping:{type:"boolean",since:"1.22"},showSelectAll:{type:"boolean",since:"1.22"},showResetAll:{type:"boolean",since:"1.22"}},aggregations:{persoService:{type:"Object",multiple:false,deprecated:true}},associations:{persoDialogFor:"sap.m.Table"},events:{confirm:{},cancel:{}},library:"sap.m"}});u.apply(D,{onDuplicate:function(t,e,o){if(e._sapui_candidateForDestroy){c.debug("destroying dangling template "+e+" when creating new object with same ID");e.destroy()}else{var i="adding TablePersoDialog with duplicate id '"+t+"'";if(sap.ui.getCore().getConfiguration().getNoDuplicateIds()){c.error(i);throw new Error("Error: "+i)}else{c.warning(i)}}}});D.prototype.init=function(){var h=this,u=0;this._oRb=sap.ui.getCore().getLibraryResourceBundle("sap.m");this._oP13nModel=new f;this._oP13nModel.setSizeLimit(Number.MAX_VALUE);this._oColumnItemTemplate=new a(this.getId()+"-cli",{selected:"{Personalization>visible}",type:"Active",cells:[new e({text:"{Personalization>text}"})],press:function(t){this._oSelectedItem=t.oSource;this._fnUpdateArrowButtons.call(this)}.bind(this)}).addStyleClass("sapMPersoDialogLI");this._oButtonUp=new n(this.getId()+"-buttonUp",{icon:"sap-icon://navigation-up-arrow",enabled:false,tooltip:h._oRb.getText("PERSODIALOG_UP"),press:function(){h._moveItem(-1)}});this._oButtonDown=new n(this.getId()+"-buttonDown",{icon:"sap-icon://navigation-down-arrow",enabled:false,tooltip:h._oRb.getText("PERSODIALOG_DOWN"),press:function(){h._moveItem(1)}});this._fnUpdateArrowButtons=function(){if(this.getHasGrouping()){return}var t=this._oInnerTable.getModel("Personalization").getProperty("/aColumns");var e,o;if(!this._oSelectedItem){e=false;o=false}else{var i=t.indexOf(this._oSelectedItem.getBindingContext("Personalization").getObject());e=i>0?true:false;o=i<t.length-1?true:false}this._updateMarkedItem();h._oButtonUp.setEnabled(e);h._oButtonDown.setEnabled(o)}.bind(this);this._fnAfterDialogOpen=function(){h._fnUpdateArrowButtons.call(h)};this._fnAfterScrollContainerRendering=function(){h._oScrollContainer.$().attr("tabindex","-1")};this._oInnerTable=new l(this.getId()+"-colTable",{noDataText:this._oRb.getText("PERSODIALOG_NO_DATA"),mode:y.MultiSelect,width:"100%",sticky:["ColumnHeaders"],columns:[new i({header:new t({text:this._oRb.getText("PERSODIALOG_SELECT_ALL")})})]});this._oSearchField=new b(this.getId()+"-searchField",{width:"100%",liveChange:function(t){var e=t.getSource().getValue(),o=e?300:0;clearTimeout(u);if(o){u=setTimeout(function(){h._executeSearch()},o)}else{h._executeSearch()}},search:function(){h._executeSearch()}});this._resetAllButton=new n(this.getId()+"-buttonUndo",{text:this._oRb.getText("VIEWSETTINGS_RESET"),tooltip:this._oRb.getText("PERSODIALOG_UNDO"),press:function(){this._resetAll()}.bind(this)}).addStyleClass("sapMPersoDialogResetBtn");var c=new r({content:[new t(this.getId()+"-Dialog-title",{text:this._oRb.getText("PERSODIALOG_COLUMNS_TITLE")}),new o,this._resetAllButton]});var p=new r(this.getId()+"-toolbar",{active:false,content:[this._oSearchField,this._oButtonUp,this._oButtonDown]});this._oDialog=new s(this.getId()+"-Dialog",{customHeader:c,draggable:true,resizable:true,stretch:d.system.phone,horizontalScrolling:false,verticalScrolling:true,initialFocus:d.system.desktop?this._oInnerTable:null,content:[this._oInnerTable],subHeader:p,leftButton:new n(this.getId()+"-buttonOk",{text:this._oRb.getText("PERSODIALOG_OK"),press:function(){h._oDialog.close();h._oSelectedItem=null;h._oSearchField.setValue("");h.fireConfirm()},type:T.Emphasized}),rightButton:new n(this.getId()+"-buttonCancel",{text:this._oRb.getText("PERSODIALOG_CANCEL"),press:function(){h._oDialog.close();h._oSelectedItem=null;h._oSearchField.setValue("");h.fireCancel()}}),afterOpen:this._fnAfterDialogOpen}).addStyleClass("sapMPersoDialog")};D.prototype._updateMarkedItem=function(){if(!this._oSelectedItem){this._oSelectedItem=this._oInnerTable&&this._oInnerTable.getItems().length>0?this._oInnerTable.getItems()[0]:null}if(this._oSelectedItem){this._oInnerTable.getItems().forEach(function(t){if(t.hasStyleClass("sapMPersoDialogItemSelected")){t.removeStyleClass("sapMPersoDialogItemSelected")}});this._oSelectedItem.addStyleClass("sapMPersoDialogItemSelected")}};D.prototype.retrievePersonalizations=function(){return this._oP13nModel.getData()};D.prototype.open=function(){var t=null;if(this.getHasGrouping()){t=[new g("group",false,true)]}this._readCurrentSettingsFromTable();this._oDialog.setModel(this._oP13nModel,"Personalization");this._oInnerTable.bindAggregation("items",{path:"Personalization>/aColumns",key:"text",sorter:t,template:this._oColumnItemTemplate});if(!this._oInnerTable.getSelectedItem()){var e=this._oInnerTable.getItems();if(this.getHasGrouping()){e=e.filter(function(t){return t.getMetadata().getName()!="sap.m.GroupHeaderListItem"})}if(e.length>0){this._sLastSelectedItemId=e[0].getBindingContext("Personalization").getProperty("id")}}this._fnUpdateArrowButtons.call(this);this._oDialog.open()};D.prototype.setContentHeight=function(t){this.setProperty("contentHeight",t,true);this._oDialog.setContentHeight(t);return this};D.prototype.setContentWidth=function(t){this.setProperty("contentWidth",t,true);this._oDialog.setContentWidth(t);return this};D.prototype.exit=function(){this._oRb=null;this._oP13nModel=null;this._oSelectedItem=null;if(this._oColumnItemTemplate){this._oColumnItemTemplate.destroy();this._oColumnItemTemplate=null}if(this._oInnerTable){this._oInnerTable.destroy();this._oInnerTable=null}if(this._oSearchField){this._oSearchField.destroy();this._oSearchField=null}if(this._oDialog){this._oDialog.destroy();this._oDialog=null}if(this._oButtonDown){this._oButtonDown.destroy();this._oButtonDown=null}if(this._oButtonUp){this._oButtonUp.destroy();this._oButtonUp=null}};D.prototype._resetAll=function(){if(this.getInitialColumnState()){var t=C.extend(true,[],this.getInitialColumnState()),e=this;var o=this._oInnerTable.getSelectedItem();this._sLastSelectedItemId=o&&o.getBindingContext("Personalization")&&o.getBindingContext("Personalization").getProperty("id");if(this._mColumnCaptions){t.forEach(function(t){t.text=e._mColumnCaptions[t.id]})}this._oP13nModel.getData().aColumns=t;this._oP13nModel.updateBindings();sap.ui.getCore().applyChanges()}};D.prototype._moveItem=function(t){var e=this._oSelectedItem;if(!e){return}var o=this._oInnerTable.getItems();var i=this._oInnerTable.getModel("Personalization").getProperty("/aColumns");var n=i.indexOf(e.getBindingContext("Personalization").getObject());var s=n+t;s=i.indexOf(o[s].getBindingContext("Personalization").getObject());if(s==n){return}i.splice(s,0,i.splice(n,1)[0]);i.forEach(function(t,e){t.order=e});this._oInnerTable.getModel("Personalization").setProperty("/aColumns",i);this._oSelectedItem=o[s];this._scrollToItem(this._oSelectedItem);this._fnUpdateArrowButtons.call(this)};D.prototype._scrollToItem=function(t){sap.ui.getCore().applyChanges();if(t.getDomRef()){var e=this._oInnerTable.getItems().indexOf(t);var o=t.getDomRef().getBoundingClientRect();var i=this._oDialog.getDomRef("cont").getBoundingClientRect();var n=i.top;var s=i.bottom;var a=o.top;if(a<n+18){this._oInnerTable.scrollToIndex(e)}else if(a>s-18){this._oInnerTable.scrollToIndex(e)}}};D.prototype._readCurrentSettingsFromTable=function(){var t=sap.ui.getCore().byId(this.getPersoDialogFor()),e=this,o=this.getColumnInfoCallback().call(this,t,this.getPersoMap());this._oP13nModel.setData({aColumns:o});this._mColumnCaptions={};o.forEach(function(t){e._mColumnCaptions[t.id]=t.text})};D.prototype._executeSearch=function(){var t=this._oSearchField.getValue(),e=new _("text",m.Contains,t),o=this._oInnerTable.getBinding("items");o.filter([e]);this._fnUpdateArrowButtons.call(this);return this};D.prototype.setHasGrouping=function(t){this.setProperty("hasGrouping",t,true);var e=this._oDialog.getSubHeader();if(!t){if(e.getContent().length===1){e.insertContent(this._oButtonDown,0);e.insertContent(this._oButtonUp,0)}}else{e.removeContent(this._oButtonUp);e.removeContent(this._oButtonDown)}return this};D.prototype.setShowSelectAll=function(e){this.setProperty("showSelectAll",e,true);var o=e?this._oRb.getText("PERSODIALOG_SELECT_ALL"):this._oRb.getText("PERSODIALOG_COLUMNS_TITLE");this._oInnerTable.getColumns()[0].setHeader(new t({text:o}));this._oInnerTable.bPreventMassSelection=!e;return this};D.prototype.setShowResetAll=function(t){this.setProperty("showResetAll",t,true);this._resetAllButton.setVisible(t);return this};return D});