/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./library","sap/ui/core/library","sap/ui/core/Core","sap/ui/core/Item","sap/ui/core/Renderer","sap/ui/core/IconPool","sap/ui/core/InvisibleText","sap/ui/core/Control","sap/ui/Device","./AccButton","sap/m/Button","sap/m/ResponsivePopover","sap/m/IconTabBarSelectList"],function(e,t,i,s,o,n,a,r,l,p,c,g,h){"use strict";var u=t.TextAlign;var d=t.TextDirection;var f=e.ButtonType;var _=e.PlacementType;var I=e.ImageHelper;var v=e.IconTabFilterDesign;var T=t.IconColor;var b=s.extend("sap.m.IconTabFilter",{metadata:{interfaces:["sap.m.IconTab","sap.ui.core.PopupInterface"],library:"sap.m",designtime:"sap/m/designtime/IconTabFilter.designtime",properties:{count:{type:"string",group:"Data",defaultValue:""},showAll:{type:"boolean",group:"Misc",defaultValue:false},icon:{type:"sap.ui.core.URI",group:"Misc",defaultValue:""},iconColor:{type:"sap.ui.core.IconColor",group:"Appearance",defaultValue:T.Default},iconDensityAware:{type:"boolean",group:"Appearance",defaultValue:true},visible:{type:"boolean",group:"Behavior",defaultValue:true},design:{type:"sap.m.IconTabFilterDesign",group:"Appearance",defaultValue:v.Vertical}},defaultAggregation:"content",aggregations:{content:{type:"sap.ui.core.Control",multiple:true,singularName:"content"},items:{type:"sap.m.IconTab",multiple:true,singularName:"item"},_expandButton:{type:"sap.m.Button",multiple:false,visibility:"hidden"}}}});var m=i.getLibraryResourceBundle("sap.m");b._aAllIconColors=["sapMITBFilterCritical","sapMITBFilterPositive","sapMITBFilterNegative","sapMITBFilterDefault","sapMITBFilterNeutral"];b.prototype._getImageControl=function(e,t,i){var s={src:this.getIcon(),densityAware:this.getIconDensityAware(),useIconTooltip:false};if(s.src){this._oImageControl=I.getImageControl(this.getId()+"-icon",this._oImageControl,t,s,e,i)}else if(this._oImageControl){this._oImageControl.destroy();this._oImageControl=null}return this._oImageControl};b.prototype.init=function(){this._oDragEventDelegate={onlongdragover:this._handleOnLongDragOver,ondragover:this._handleOnDragOver,ondragleave:this._handleOnDragLeave,ondrop:this._handleOnDrop}};b.prototype.exit=function(e){if(this._oImageControl){this._oImageControl.destroy()}if(s.prototype.exit){s.prototype.exit.call(this,e)}if(this._invisibleText){this._invisibleText.destroy();this._invisibleText=null}if(this._oPopover){this._oPopover.destroy();this._oPopover=null}if(this._oExpandButton){this._oExpandButton.removeEventDelegate(this._oDragEventDelegate);this._oExpandButton.destroy();this._oExpandButton=null}this.removeEventDelegate(this._oDragEventDelegate);this._oDragEventDelegate=null};b.prototype.invalidate=function(){var e=this.getParent(),t,i;if(!e){return}t=e.getParent();if(!(t instanceof sap.m.IconTabBar)){e.invalidate();return}i=t.getParent();if(i instanceof sap.m.ObjectHeader){i.invalidate()}else{t.invalidate()}};b.prototype.setProperty=function(e,t,i){switch(e){case"enabled":case"textDirection":case"text":case"count":case"showAll":case"icon":case"iconColor":case"iconDensityAware":case"design":if(this.getProperty(e)===t){return this}r.prototype.setProperty.call(this,e,t,true);if(!i){var s=this.getParent();if(s instanceof sap.m.IconTabHeader){s.invalidate()}}break;default:r.prototype.setProperty.apply(this,arguments);break}return this};b.prototype._getNonEmptyKey=function(){var e=this.getKey();if(e){return e}return this.getId()};b.prototype._getRealTab=function(){return this._oRealItem||this};b.prototype._getRootTab=function(){var e=this._getRealTab(),t=e.getParent();while(t&&t.isA("sap.m.IconTabFilter")){e=t;t=t.getParent()}return e};b.prototype._getNestedLevel=function(){var e=this._getRealTab().getParent(),t;for(t=1;e&&e.isA("sap.m.IconTabFilter");t++){e=e.getParent()}return t};b.prototype.render=function(e,t,i){if(!this.getVisible()){return}this._prepareDragEventDelegate();var s=this.getParent(),o=s.getParent(),a=s._isInsideIconTabBar(),r={role:"tab"},l=this.getId(),p=this.getCount(),c=this.getText(),g=this.getIcon(),h=this.getIconColor(),u=h==="Positive"||h==="Critical"||h==="Negative",d=this.getDesign()===v.Horizontal,f=s._bTextOnly,_=s._bInLine||s.isInlineMode();if(a){r.controls=o.getId()+"-content"}if(this.getItems().length){r.roledescription=m.getText("ICONTABFILTER_SPLIT_TAB")}if(c.length||p!==""||g){var I=[];if(p!==""){I.push(l+"-count")}if(c.length){I.push(l+"-text")}if(g){I.push(l+"-icon")}if(u){I.push(l+"-iconColor")}r.labelledby=I.join(" ")}if(t!==undefined&&i!==undefined){Object.assign(r,{posinset:t+1,setsize:i})}e.openStart("div",this).accessibilityState(r).class("sapMITBItem");if(!p){e.class("sapMITBItemNoCount")}if(d){e.class("sapMITBHorizontal")}else{e.class("sapMITBVertical")}if(this.getShowAll()){e.class("sapMITBAll")}else{e.class("sapMITBFilter").class("sapMITBFilter"+h)}if(s._isUnselectable(this)){e.class("sapMITHUnselectable")}if(this.getItems().length>0){e.class("sapMITBFilterWithItems")}if(!this.getEnabled()){e.class("sapMITBDisabled").attr("aria-disabled",true)}e.attr("aria-selected",false);var T=this.getTooltip_AsString();if(T){e.attr("title",T)}if(this._bIsOverflow||this.getItems().length){e.attr("aria-haspopup","menu")}e.openEnd();e.openStart("div").class("sapMITBFilterWrapper").openEnd();if(!_){e.openStart("div",l+"-tab").class("sapMITBTab").openEnd();if(!this.getShowAll()||!g){if(u){e.openStart("div",l+"-iconColor").style("display","none").openEnd().text(m.getText("ICONTABBAR_ICONCOLOR_"+h.toUpperCase())).close("div")}e.renderControl(this._getImageControl(["sapMITBFilterIcon","sapMITBFilter"+h],s,b._aAllIconColors))}if(!this.getShowAll()&&!g&&!f){e.openStart("span").class("sapMITBFilterNoIcon").openEnd().close("span")}if(d&&!this.getShowAll()){e.close("div");e.openStart("div").class("sapMITBHorizontalWrapper").openEnd()}e.openStart("span",l+"-count").class("sapMITBCount").openEnd();if(p===""&&d){e.unsafeHtml("&nbsp;")}else{e.text(p)}e.close("span");if(!d){e.close("div")}}if(c.length){e.openStart("div",l+"-text").class("sapMITBText");if(a&&o.getUpperCase()){e.class("sapMITBTextUpperCase")}if(_){e.attr("dir","ltr")}e.openEnd();e.openStart("span").class("sapMITHTextContent").openEnd().text(s._getDisplayText(this));e.close("span");if(this._bIsOverflow||this.getItems().length&&s._isUnselectable(this)){e.openStart("span",this.getId()+"-expandButton").class("sapMITHShowSubItemsIcon").openEnd();e.icon(n.getIconURI("slim-arrow-down"),[],{title:m.getText("ICONTABHEADER_OVERFLOW_MORE")});e.close("span")}e.close("div")}if(!_&&d){e.close("div")}e.openStart("div").class("sapMITBContentArrow").openEnd().close("div");e.close("div");if(this.getItems().length&&!s._isUnselectable(this)){e.openStart("span").accessibilityState({role:"separator"}).openEnd().close("span");e.renderControl(this._getExpandButton())}e.close("div")};b.prototype.renderInSelectList=function(e,t,i,s,o){if(this._invisibleText){this._invisibleText.destroy();this._invisibleText=null}if(!this.getVisible()){return}var n=true,r=t._bIconOnly,l=t._oIconTabHeader;if(l){n=l._bTextOnly}e.openStart("li",this).class("sapMITBSelectItem").attr("tabindex","-1").attr("role","menuitem");if(o){e.style("padding-left",o+"rem")}if(i!==undefined&&s!==undefined){e.attr("aria-posinset",i+1);e.attr("aria-setsize",s);e.attr("aria-level",this._getNestedLevel())}var p=this.getTooltip_AsString();if(p){e.attr("title",p)}if(l._isUnselectable(this)){e.class("sapMITHUnselectable")}if(!this.getEnabled()){e.class("sapMITBDisabled").attr("aria-disabled",true)}if(t.getSelectedItem()==this){e.class("sapMITBSelectItemSelected");e.attr("aria-selected",true)}var c=this.getIconColor();e.class("sapMITBFilter"+c);var g=this.getId(),h=c=="Positive"||c=="Critical"||c=="Negative",u=[];if(!r){u.push(g+"-text")}if(!n&&this.getIcon()){u.push(g+"-icon")}if(h){this._invisibleText=new a({text:m.getText("ICONTABBAR_ICONCOLOR_"+c.toUpperCase())});u.push(this._invisibleText.getId())}e.accessibilityState({labelledby:u.join(" ")}).openEnd();if(this._invisibleText){e.renderControl(this._invisibleText)}if(!n){this._renderIcon(e)}if(!r){this._renderText(e)}e.close("li")};b.prototype._renderIcon=function(e){var t=this.getIcon();if(t){var i=n.getIconInfo(t),s=["sapMITBSelectItemIcon"];if(i&&!i.suppressMirroring){s.push("sapUiIconMirrorInRTL")}e.icon(t,s,{id:this.getId()+"-icon","aria-hidden":true})}else{e.openStart("span").class("sapUiIcon").openEnd().close("span")}};b.prototype._renderText=function(e){var t=this.getText(),s=this.getCount(),n=i.getConfiguration().getRTL(),a=this.getTextDirection();e.openStart("span",this.getId()+"-text").attr("dir","ltr").class("sapMText").class("sapMTextNoWrap").class("sapMITBText");if(a!==d.Inherit){e.attr("dir",a.toLowerCase())}var r=o.getTextAlign(u.Begin,a);if(r){e.style("text-align",r)}if(s){if(n){t="("+s+") "+t}else{t+=" ("+s+")"}}e.openEnd().text(t).close("span")};b.prototype._getSelectList=function(){if(!this._oSelectList){this._oSelectList=new h({selectionChange:function(e){var t=e.getParameter("selectedItem");this._oIconTabHeader.setSelectedItem(t._getRealTab());this._oTabFilter._closePopover()}});this._oSelectList._oIconTabHeader=this.getParent();this._oSelectList._oTabFilter=this}return this._oSelectList};b.prototype._prepareDragEventDelegate=function(){var e=this._getExpandButton();if(this._getIconTabHeader()._isUnselectable(this)){e.removeEventDelegate(this._oDragEventDelegate);this.addEventDelegate(this._oDragEventDelegate,this)}else{e.addEventDelegate(this._oDragEventDelegate,this);this.removeEventDelegate(this._oDragEventDelegate)}};b.prototype._getExpandButton=function(){this._oExpandButton=this.getAggregation("_expandButton");if(!this._oExpandButton){this._oExpandButton=new p(this.getId()+"-expandButton",{type:f.Transparent,icon:n.getIconURI("slim-arrow-down"),tooltip:m.getText("ICONTABHEADER_OVERFLOW_MORE"),tabIndex:"-1",press:this._expandButtonPress.bind(this)}).addStyleClass("sapMITBFilterExpandBtn");this.setAggregation("_expandButton",this._oExpandButton)}return this._oExpandButton};b.prototype._expandButtonPress=function(){if(!this.getEnabled()){return}this.$().trigger("focus");if(!this._oPopover){this._oPopover=new g({showArrow:false,showHeader:false,offsetY:0,offsetX:0,placement:_.VerticalPreferredBottom}).addStyleClass("sapMITBFilterPopover");this._oPopover.attachBeforeClose(function(){this._getSelectList().destroyItems()},this);if(l.system.phone){this._oPopover._oControl.addButton(this._createPopoverCloseButton())}this.addDependent(this._oPopover);this._oPopover._oControl._adaptPositionParams=function(){var e=this.$().parents().hasClass("sapUiSizeCompact");this._arrowOffset=0;if(e){this._offsets=["0 0","0 0","0 4","0 0"]}else{this._offsets=["0 0","0 0","0 5","0 0"]}this._atPositions=["end top","end top","end bottom","begin top"];this._myPositions=["end bottom","begin top","end top","end top"]}}var e=this._setSelectListItems();var t=this._getSelectList();this._oPopover.removeAllContent();this._oPopover.addContent(t);this._oPopover.setInitialFocus(e?t.getSelectedItem():t.getVisibleTabFilters()[0]);var i=this;if(!this._getIconTabHeader()._isUnselectable(this)){i=this._getExpandButton()}this._oPopover.openBy(i)};b.prototype._getAllSubItems=function(){var e=[];this._getRealTab().getItems().forEach(function(t){if(t.isA("sap.m.IconTabFilter")){e=e.concat(t,t._getAllSubItems())}else{e=e.concat(t)}});return e};b.prototype._getAllSubFilters=function(){return this._getAllSubItems().filter(function(e){return e.isA("sap.m.IconTabFilter")})};b.prototype._getAllSubFiltersDomRefs=function(){return this._getAllSubFilters().filter(function(e){return Boolean(e._getRealTab().getDomRef())}).map(function(e){return e._getRealTab().getDomRef()})};b.prototype._getFirstAvailableSubFilter=function(){var e=this._getAllSubFilters();for(var t=0;t<e.length;t++){var i=e[t];if(i.getContent().length&&i.getVisible()){return i}}return this};b.prototype._isParentOf=function(e){var t=this._getAllSubFilters();for(var i=0;i<t.length;i++){if(t[i]._getRealTab()===e){return true}}return false};b.prototype._createPopoverCloseButton=function(){return new c({text:m.getText("SELECT_CANCEL_BUTTON"),press:this._closePopover.bind(this)})};b.prototype._closePopover=function(){if(this._oPopover){this._oPopover.close();this._oPopover.removeAllContent()}if(this._bIsOverflow&&this.getParent().oSelectedItem){(this.getParent()._oSelectedRootItem||this.getParent().oSelectedItem).$().focus()}};b.prototype._handleOnDragOver=function(e){if(!this._bIsOverflow&&!this._getIconTabHeader().getMaxNestingLevel()){return}this._getDragOverDomRef().classList.add("sapMITHDragOver");e.preventDefault()};b.prototype._handleOnLongDragOver=function(){if(!this._bIsOverflow&&!this._getIconTabHeader().getMaxNestingLevel()){return}if(this._oPopover&&this._oPopover.isOpen()){return}this._expandButtonPress()};b.prototype._handleOnDrop=function(){this._getDragOverDomRef().classList.remove("sapMITHDragOver")};b.prototype._handleOnDragLeave=function(){this._getDragOverDomRef().classList.remove("sapMITHDragOver")};b.prototype._setSelectListItems=function(){var e=this.getParent(),t=this._getSelectList(),i=this._getAllSubItems(),s=e.oSelectedItem,o=false,n;if(this._bIsOverflow){var a=e.getItems();var r=e._getItemsInStrip();i=[];a.forEach(function(e){if(!l.system.phone&&r.indexOf(e)>-1){return}i.push(e);if(e.isA("sap.m.IconTabFilter")){e._getAllSubItems().forEach(function(e){i.push(e)})}})}t.destroyItems();t.setSelectedItem(null);for(var p=0;p<i.length;p++){n=i[p];var c=n.clone(undefined,undefined,{cloneChildren:false,cloneBindings:true});c._oRealItem=n;t.addItem(c);if(n.isA("sap.m.IconTabSeparator")){continue}if(c._getRealTab()===s){t.setSelectedItem(c);o=true;continue}if(c._getRealTab()._isParentOf(s)){t.setSelectedItem(s._getRealTab());o=true}}return o};b.prototype._getIconTabHeader=function(){return this._getRootTab().getParent()};b.prototype._getDragOverDomRef=function(){if(this._getIconTabHeader()._isUnselectable(this)){return this.getDomRef()}return this.getDomRef().getElementsByClassName("sapMITBFilterExpandBtn")[0]};b.prototype.onsapdown=function(e){if(!this.getEnabled()){return}if(this._bIsOverflow||this._getNestedLevel()===1&&this._getRealTab()===this&&this._getRealTab().getItems().length!==0){e.stopImmediatePropagation();this._expandButtonPress()}};return b});