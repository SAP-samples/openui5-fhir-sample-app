/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/base/DataType","sap/ui/base/ManagedObject","sap/ui/core/CustomData","./mvc/View","./mvc/EventHandlerResolver","./ExtensionPoint","./StashedControlSupport","sap/ui/base/SyncPromise","sap/base/Log","sap/base/util/ObjectPath","sap/base/util/values","sap/base/assert","sap/base/security/encodeXML","sap/base/util/LoaderExtensions","sap/base/util/JSTokenizer","sap/base/util/isEmptyObject"],function(e,t,n,r,i,a,o,s,u,l,f,c,p,d,g,m,v){"use strict";function h(e,r,i,a,o){var s=n.bindingParser(r,a,true,false,false,false,o);if(s&&typeof s==="object"){return s}var u=r=s||r;var f=t.getType(e);if(f){if(f instanceof t){u=f.parseValue(r,{context:a,locals:o});if(!f.isValid(u)){l.error("Value '"+r+"' is not valid for type '"+f.getName()+"'.")}}}else{throw new Error("Property "+i+" has unknown type "+e)}return typeof u==="string"?n.bindingParser.escape(u):u}function w(e){return e.localName||e.baseName||e.nodeName}function y(e){if(e.isRejected()){throw e.getResult()}return e.getResult()}function b(e,t){function n(e,n,r,i){var a,o,s=[];for(a=e.firstChild;a;a=a.nextSibling){o=t(e,n,r,a,false,i);if(o){s.push(y(o))}}return u.resolve(s)}function r(e,n,r,i){var a,o=Promise.resolve(),s=[i];for(a=e.firstChild;a;a=a.nextSibling){o=o.then(t.bind(null,e,n,r,a,false,i));s.push(o)}return Promise.all(s)}return e?r:n}var _={};_.loadTemplate=function(e,t){var n=e.replace(/\./g,"/")+("."+(t||"view")+".xml");return g.loadResource(n).documentElement};_.loadTemplatePromise=function(e,t){var n=e.replace(/\./g,"/")+("."+(t||"view")+".xml");return g.loadResource(n,{async:true}).then(function(e){return e.documentElement})};_.parseViewAttributes=function(e,t,n){var r=t.getMetadata().getAllProperties();for(var i=0;i<e.attributes.length;i++){var a=e.attributes[i];if(a.name==="controllerName"){t._controllerName=a.value}else if(a.name==="resourceBundleName"){t._resourceBundleName=a.value}else if(a.name==="resourceBundleUrl"){t._resourceBundleUrl=a.value}else if(a.name==="resourceBundleLocale"){t._resourceBundleLocale=a.value}else if(a.name==="resourceBundleAlias"){t._resourceBundleAlias=a.value}else if(a.name==="class"){t.addStyleClass(a.value)}else if(!n[a.name]&&r[a.name]){n[a.name]=h(r[a.name].type,a.value,a.name,t._oContainingView.oController)}}};_.enrichTemplateIds=function(e,t){_.enrichTemplateIdsPromise(e,t,false);return e};_.enrichTemplateIdsPromise=function(e,t,n){return N(e,t,true,n).then(function(){return e})};_.parseTemplate=function(e,t){return y(_.parseTemplatePromise(e,t,false))};_.parseTemplatePromise=function(e,t,n,r){return N(e,t,false,n,r).then(function(){var e=u.resolve();var r=arguments;if(t.isA("sap.ui.core.mvc.View")&&t._epInfo&&t._epInfo.all.length>0){e=I(n,t,{content:t._epInfo.all})}return e.then(function(){if(Array.isArray(r[0])){r[0]=r[0].filter(function(e){return!e._isExtensionPoint})}return r[0]})})};function C(e){var t,n=/^[a-zA-Z_$][a-zA-Z0-9_$]*$/;if(!e||typeof e!=="object"){t="core:require in XMLView can't be parsed to a valid object"}else{Object.keys(e).some(function(r){if(!n.test(r)){t="core:require in XMLView contains invalid identifier: '"+r+"'";return true}if(!e[r]||typeof e[r]!=="string"){t="core:require in XMLView contains invalide value '"+e[r]+"'under key '"+r+"'";return true}})}return t}function x(e,t){var n=e.getAttributeNS("sap.ui.core","require"),r,i,a;if(n){try{r=m.parseJS(n)}catch(t){l.error("Require attribute can't be parsed on Node: ",e.nodeName);throw t}a=C(r);if(a){throw new Error(a+" on Node: "+e.nodeName)}if(!v(r)){i={};if(t){return new Promise(function(e,t){var n=Object.keys(r).reduce(function(e,t){i[t]=sap.ui.require(r[t]);return e&&i[t]!==undefined},true);if(n){e(i);return}sap.ui.require(c(r),function(){var t=arguments;Object.keys(r).forEach(function(e,n){i[e]=t[n]});e(i)},t)})}else{Object.keys(r).forEach(function(e){i[e]=sap.ui.requireSync(r[e])});return u.resolve(i)}}}}function I(e,t,n){var r=u.resolve();if(!v(n)){var i=[];var a;if(e){r=new Promise(function(e){a=e})}Object.keys(n).forEach(function(e){var r=n[e];r.forEach(function(e){e.targetControl=t;var n=sap.ui.require(e.providerClass);if(n){i.push(n.applyExtensionPoint(e))}else{var r=new Promise(function(t,n){sap.ui.require([e.providerClass],function(e){t(e)},n)}).then(function(t){return t.applyExtensionPoint(e)});i.push(r)}})});if(e){Promise.all(i).then(a)}}return r}function N(t,c,g,m,C){var N=[],R=x(t,m)||u.resolve();m=m&&c._sProcessingMode==="sequential";l.debug("XML processing mode is "+(m?"sequential":"default"),"","XMLTemplateProcessor");var P=sap.ui.getCore().getConfiguration().getDesignMode();if(P){c._sapui_declarativeSourceInfo={xmlNode:t,xmlRootNode:c._oContainingView===c?t:c._oContainingView._sapui_declarativeSourceInfo.xmlRootNode}}var M=c.sViewName||c._sFragmentName;if(!M){var V=c;var A=0;while(++A<1e3&&V&&V!==V._oContainingView){V=V._oContainingView}M=V.sViewName}if(c.isSubView()){L(t,true,false,R)}else{if(t.localName==="View"&&t.namespaceURI!=="sap.ui.core.mvc"){l.warning("XMLView root node must have the 'sap.ui.core.mvc' namespace, not '"+t.namespaceURI+"'"+(M?" (View name: "+M+")":""))}U(t,false,false,R)}var S=0;function E(){for(;S<N.length;S++){var e=N[S];if(e&&typeof e.then==="function"){return e.then(T).then(E)}}return N}function T(e){var t=[S,1].concat(e);Array.prototype.splice.apply(N,t)}return R.then(E);function O(e){return e}function q(e){return c._oContainingView.createId(e)}function L(e,t,n,r){if(e.nodeType===1){var i=w(e);if(e.namespaceURI==="http://www.w3.org/1999/xhtml"||e.namespaceURI==="http://www.w3.org/2000/svg"){N.push("<"+i+" ");var a=false;for(var o=0;o<e.attributes.length;o++){var s=e.attributes[o];var u=s.value;if(s.name==="id"){a=true;u=W(c,e)}N.push(s.name+'="'+d(u)+'" ')}if(t===true){N.push("data-sap-ui-preserve"+'="'+c.getId()+'" ');if(!a){N.push("id"+'="'+c.getId()+'" ')}}N.push(">");var l=e;if(window.HTMLTemplateElement&&e instanceof HTMLTemplateElement&&e.content instanceof DocumentFragment){l=e.content}U(l,false,false,r);N.push("</"+i+">")}else if(i==="FragmentDefinition"&&e.namespaceURI==="sap.ui.core"){U(e,false,true,r)}else{R=R.then(function(){return k(e,r).then(function(e){for(var t=0;t<e.length;t++){var n=e[t];if(c.getMetadata().hasAggregation("content")){c._epInfo=c._epInfo||{contentControlsCount:0,last:null,all:[]};if(n._isExtensionPoint){n.index=c._epInfo.contentControlsCount;n.targetControl=c;n.aggregationName="content";if(c._epInfo.last){c._epInfo.last._nextSibling=n}c._epInfo.last=n;c._epInfo.all.push(n)}else{c._epInfo.contentControlsCount++;c.addAggregation("content",n)}}else if(c.getMetadata().hasAssociation("content")){c.addAssociation("content",n)}}return e})});N.push(R)}}else if(e.nodeType===3&&!n){var f=e.textContent||e.text,p=w(e.parentNode);if(f){if(p!="style"){f=d(f)}N.push(f)}}}function U(e,t,n,r){var i=e.childNodes;for(var a=0;a<i.length;a++){L(i[a],t,n,r)}}function j(t,n){var r;var i=sap.ui.getCore().getLoadedLibraries();e.each(i,function(e,i){if(t===i.namespace||t===i.name){r=i.name+"."+(i.tagNames&&i.tagNames[n]||n)}});r=r||t+"."+n;function a(e){if(!e){l.error("Control '"+r+"' did not return a class definition from sap.ui.define.","","XMLTemplateProcessor");e=f.get(r)}if(!e){l.error("Can't find object class '"+r+"' for XML-view","","XMLTemplateProcessor")}return e}var o=r.replace(/\./g,"/");var s=sap.ui.require(o);if(!s){if(m){return new Promise(function(e,t){sap.ui.require([o],function(t){t=a(t);e(t)},t)})}else{s=sap.ui.requireSync(o);s=a(s)}}return s}function X(e,t){if(e.namespaceURI==="http://www.w3.org/1999/xhtml"||e.namespaceURI==="http://www.w3.org/2000/svg"){var n=e.attributes["id"]?e.attributes["id"].textContent||e.attributes["id"].text:null;if(g){return _.enrichTemplateIdsPromise(e,c,m).then(function(){return[]})}else{var r=function(t){var r={id:n?W(c,e,n):undefined,xmlNode:e,containingView:c._oContainingView,processingMode:c._sProcessingMode};if(c.fnScopedRunWithOwner){return c.fnScopedRunWithOwner(function(){return new t(r)})}return new t(r)};if(m){return new Promise(function(e,t){sap.ui.require(["sap/ui/core/mvc/XMLView"],function(t){e([r(t)])},t)})}else{var i=sap.ui.requireSync("sap/ui/core/mvc/XMLView");return u.resolve([r(i)])}}}else{return k(e,t)}}function k(e,t){if(w(e)==="ExtensionPoint"&&e.namespaceURI==="sap.ui.core"){if(g){return u.resolve([])}else{var n=c instanceof i?c._oContainingView:c;var r=o._factory.bind(null,n,e.getAttribute("name"),function(){var n=u.resolve();var r=[];var i=e.childNodes;for(var a=0;a<i.length;a++){var o=i[a];if(o.nodeType===1){n=n.then(X.bind(null,o,t));r.push(n)}}return u.all(r).then(function(e){var t=[];e.forEach(function(e){t=t.concat(e)});return t})});return u.resolve(c.fnScopedRunWithOwner?c.fnScopedRunWithOwner(r):r())}}else{var a=j(e.namespaceURI,w(e));if(a&&typeof a.then==="function"){return a.then(function(n){return B(e,n,t)})}else{return B(e,a,t)}}}function B(t,o,f){var d=t.namespaceURI,N={},R={},M="",V=[],A=null,S=null;if(!o){return u.resolve([])}var E=o.getMetadata();var T=E.getAllSettings();var L=x(t,m);if(L){f=u.all([f,L]).then(function(e){return Object.assign({},e[0],e[1])})}f=f.then(function(e){if(v(e)){e=null}if(!g){for(var s=0;s<t.attributes.length;s++){var u=t.attributes[s],f=u.name,d=T[f],m=u.value;if(f==="id"){N[f]=W(c,t,m)}else if(f==="class"){M+=m}else if(f==="viewName"){N[f]=m}else if(f==="fragmentName"){N[f]=m;N["containingView"]=c._oContainingView}else if(f==="binding"&&!d||f==="objectBindings"){var y=n.bindingParser(m,c._oContainingView.oController);if(y){N.objectBindings=N.objectBindings||{};N.objectBindings[y.model||undefined]=y}}else if(f==="metadataContexts"){var b=null;try{b=_._calculatedModelMapping(m,c._oContainingView.oController,true)}catch(e){l.error(c+":"+e.message)}if(b){N.metadataContexts=b;if(_._preprocessMetadataContexts){_._preprocessMetadataContexts(o.getMetadata().getName(),N,c._oContainingView.oController)}}}else if(f.indexOf(":")>-1){if(u.namespaceURI==="http://schemas.sap.com/sapui5/extension/sap.ui.core.CustomData/1"){var C=w(u);V.push(new r({key:C,value:h("any",m,C,c._oContainingView.oController)}))}else if(u.namespaceURI==="http://schemas.sap.com/sapui5/extension/sap.ui.core.support.Support.info/1"){S=m}else if(u.namespaceURI&&u.namespaceURI.indexOf("http://schemas.sap.com/sapui5/preprocessorextension/")===0){l.debug(c+": XMLView parser ignored preprocessor attribute '"+f+"' (value: '"+m+"')")}else if(f.indexOf("xmlns:")!==0){if(!A){A={}}if(!A.hasOwnProperty(u.namespaceURI)){A[u.namespaceURI]={}}A[u.namespaceURI][w(u)]=u.nodeValue;l.debug(c+": XMLView parser encountered unknown attribute '"+f+"' (value: '"+m+"') with unknown namespace, stored as sap-ui-custom-settings of customData")}}else if(d&&d._iKind===0){N[f]=h(d.type,m,f,c._oContainingView.oController,e)}else if(d&&d._iKind===1&&d.altTypes){N[f]=h(d.altTypes[0],m,f,c._oContainingView.oController,e)}else if(d&&d._iKind===2){var y=n.bindingParser(m,c._oContainingView.oController,false,false,false,false,e);if(y){N[f]=y}else{l.error(c+": aggregations with cardinality 0..n only allow binding paths as attribute value (wrong value: "+f+"='"+m+"')")}}else if(d&&d._iKind===3){N[f]=q(m)}else if(d&&d._iKind===4){N[f]=m.split(/[\s,]+/g).filter(O).map(q)}else if(d&&d._iKind===5){var x=[];a.parse(m).forEach(function(t){var n=a.resolveEventHandler(t,c._oContainingView.oController,e);if(n){x.push(n)}else{l.warning(c+': event handler function "'+t+'" is not a function or does not exist in the controller.')}});if(x.length){N[f]=x}}else if(d&&d._iKind===-1){if(i.prototype.isPrototypeOf(o.prototype)&&f=="async"){N[f]=h(d.type,m,f,c._oContainingView.oController,e)}else{l.warning(c+": setting '"+f+"' for class "+E.getName()+" (value:'"+m+"') is not supported")}}else{p(f==="xmlns",c+": encountered unknown setting '"+f+"' for class "+E.getName()+" (value:'"+m+"')");if(_._supportInfo){_._supportInfo({context:t,env:{caller:"createRegularControls",error:true,info:"unknown setting '"+f+"' for class "+E.getName()}})}}}if(A){V.push(new r({key:"sap-ui-custom-settings",value:A}))}if(V.length>0){N.customData=V}}return e});var U=b(m,j);function j(t,n,r,i,a,o){var u,l;if(i.nodeType===1){if(i.namespaceURI==="http://schemas.sap.com/sapui5/extension/sap.ui.core.xmlcomposite/1"){N[w(i)]=i.querySelector("*");return}u=i.namespaceURI===d&&r&&r[w(i)];if(u){return U(i,u,false,o)}else if(n){if(!a&&i.getAttribute("stashed")==="true"&&!g){l=function(){s.createStashedControl(W(c,i),{sParentId:N["id"],sParentAggregationName:n.name,fnCreate:function(){var e=m;m=false;try{return y(j(t,n,r,i,true,o))}finally{m=e}}})};if(c.fnScopedRunWithOwner){c.fnScopedRunWithOwner(l)}else{l()}return}return X(i,o).then(function(e){for(var t=0;t<e.length;t++){var r=e[t];var i=n.name;if(r._isExtensionPoint){if(!N[i]){N[i]=[]}var a=R[i];if(!a){a=R[i]=[]}r.index=N[i].length;r.aggregationName=i;var o=a[a.length-1];if(o){o._nextSibling=r}a.push(r)}else if(n.multiple){if(!N[i]){N[i]=[]}if(typeof N[i].path==="string"){p(!N[i].template,"list bindings support only a single template object");N[i].template=r}else{N[i].push(r)}}else{p(!N[i],"multiple aggregates defined for aggregation with cardinality 0..1");N[i]=r}}return e})}else if(w(t)!=="FragmentDefinition"||t.namespaceURI!=="sap.ui.core"){throw new Error("Cannot add direct child without default aggregation defined for control "+E.getElementName())}}else if(i.nodeType===3){if(e.trim(i.textContent||i.text)){throw new Error("Cannot add text nodes as direct child of an aggregation. For adding text to an aggregation, a surrounding html tag is needed: "+e.trim(i.textContent||i.text))}}}var k=E.getDefaultAggregation();var B=E.getAllAggregations();return U(t,k,B,f).then(function(){var e;var n=u.resolve();if(g&&t.hasAttribute("id")){D(c,t)}else if(!g){if(i.prototype.isPrototypeOf(o.prototype)&&typeof o._sType==="string"){var r=function(){if(o.getMetadata().isA("sap.ui.core.mvc.XMLView")&&c._sProcessingMode==="sequential"){N.processingMode="sequential"}return i._legacyCreate(N,undefined,o._sType)};if(c.fnScopedRunWithOwner){e=c.fnScopedRunWithOwner(r)}else{e=r()}}else{var a=function(){var e;if(o.getMetadata().isA("sap.ui.core.Fragment")&&t.getAttribute("type")!=="JS"&&c._sProcessingMode==="sequential"){N.processingMode="sequential"}if(c.fnScopedRunWithOwner){e=c.fnScopedRunWithOwner(function(){var e=new o(N);return e})}else{e=new o(N)}n=I(m,e,R);return e};if(C&&C.fnRunWithPreprocessor){e=C.fnRunWithPreprocessor(a)}else{e=a()}}if(M&&e.addStyleClass){e.addStyleClass(M)}}if(!e){e=[]}else if(!Array.isArray(e)){e=[e]}if(_._supportInfo&&e){for(var s=0,l=e.length;s<l;s++){var f=e[s];if(f&&f.getId()){var p=_._supportInfo({context:t,env:{caller:"createRegularControls",nodeid:t.getAttribute("id"),controlid:f.getId()}}),d=S?S+",":"";d+=p;_._supportInfo.addSupportInfo(f.getId(),d)}}}if(P){e.forEach(function(e){if(E.getCompositeAggregationName){var n=t.getElementsByTagName(e.getMetadata().getCompositeAggregationName());for(var r=0;r<n.length;r++){t.removeChild(n[0])}}e._sapui_declarativeSourceInfo={xmlNode:t,xmlRootNode:c._sapui_declarativeSourceInfo.xmlRootNode,fragmentName:E.getName()==="sap.ui.core.Fragment"?N["fragmentName"]:null}})}return n.then(function(){return e})})}function W(e,t,n){if(t.getAttributeNS("http://schemas.sap.com/sapui5/extension/sap.ui.core.Internal/1","id")){return t.getAttribute("id")}else{return q(n?n:t.getAttribute("id"))}}function D(e,t){t.setAttribute("id",q(t.getAttribute("id")));t.setAttributeNS("http://schemas.sap.com/sapui5/extension/sap.ui.core.Internal/1","id",true)}}_._preprocessMetadataContexts=null;_._calculatedModelMapping=function(e,t,r){var i,a={},o=n.bindingParser(e,t);function s(e){if(e.length%2===0){throw new Error("The last entry is no binding")}for(var t=1;t<=e.length;t=t+2){if(typeof e[t-1]=="string"){throw new Error("Binding expected not a string")}if(e[t]){if(typeof e[t]!="string"||e[t]!=","){throw new Error("Missing delimiter ','")}}}}if(o){if(!o.formatter){i=o;o={parts:[i]}}else{s(o.formatter.textFragments)}for(var u=0;u<o.parts.length;u++){i=o.parts[u];a[i.model]=a[i.model]||(r?[]:null);if(Array.isArray(a[i.model])){a[i.model].push(i)}else{a[i.model]=i}}}return a};return _},true);