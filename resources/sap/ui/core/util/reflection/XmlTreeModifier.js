/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./BaseTreeModifier","sap/ui/base/ManagedObject","sap/ui/base/DataType","sap/base/util/merge","sap/ui/util/XMLHelper","sap/ui/core/mvc/EventHandlerResolver","sap/base/util/includes","sap/base/util/ObjectPath","sap/base/util/isPlainObject","sap/ui/core/Fragment"],function(e,t,r,n,i,a,o,g,u){"use strict";var s=n({},e,{targets:"xmlTree",setVisible:function(e,t){if(t){e.removeAttribute("visible")}else{e.setAttribute("visible",t)}},getVisible:function(e){return s.getProperty(e,"visible")},setStashed:function(e,t){if(!t){e.removeAttribute("stashed")}else{e.setAttribute("stashed",t)}s.setVisible(e,!t)},getStashed:function(e){return s.getProperty(e,"stashed")||!s.getProperty(e,"visible")},bindProperty:function(e,t,r){e.setAttribute(t,"{"+r+"}")},unbindProperty:function(e,t){e.removeAttribute(t)},_setProperty:function(e,t,r,n){var i=s._getSerializedValue(r);if(n){i=s._escapeCurlyBracketsInString(i)}e.setAttribute(t,i)},setProperty:function(e,t,r){s._setProperty(e,t,r,true)},getProperty:function(e,n){var i=e.getAttribute(n);var a=s.getControlMetadata(e).getProperty(n);if(a){var o=a.getType();if(n==="value"&&s.getControlType(e)==="sap.ui.core.CustomData"&&s.getProperty(e,"key")==="sap-ui-custom-settings"){o=r.getType("object")}if(i===null){i=a.getDefaultValue()||o.getDefaultValue()}else{var g=t.bindingParser(i,undefined,true);if(u(g)){if(g.path||g.parts){i=undefined}else{i=g}}else{i=o.parseValue(g||i)}}}return i},isPropertyInitial:function(e,t){var r=e.getAttribute(t);return r==null},setPropertyBinding:function(e,t,r){if(typeof r!=="string"){throw new Error("For XML, only strings are supported to be set as property binding.")}e.setAttribute(t,r)},getPropertyBinding:function(e,r){var n=e.getAttribute(r);if(n){var i=t.bindingParser(n,undefined,true);if(i&&(i.path||i.parts)){return i}}},createControl:function(e,t,r,n,i,a){var o,g,u;if(!s.bySelector(n,t,r)){var l=e.split(".");var f="";if(l.length>1){g=l.pop();f=l.join(".")}var c=r.ownerDocument.createElementNS(f,g);o=s.getControlIdBySelector(n,t);if(o){c.setAttribute("id",o)}if(i){s.applySettings(c,i)}return a?Promise.resolve(c):c}else{u=new Error("Can't create a control with duplicated ID "+o);if(a){return Promise.reject(u)}throw u}},applySettings:function(e,t){var r=s.getControlMetadata(e);var n=r.getJSONKeys();Object.keys(t).forEach(function(r){var i=n[r];var a=t[r];switch(i._iKind){case 0:s._setProperty(e,r,a,false);break;case 3:s.setAssociation(e,r,a);break;default:throw new Error("Unsupported in applySettings on XMLTreeModifier: "+r)}})},_byId:function(e,t){if(t){if(t.ownerDocument&&t.ownerDocument.getElementById&&t.ownerDocument.getElementById(e)){return t.ownerDocument.getElementById(e)}else{return t.querySelector("[id='"+e+"']")}}},getId:function(e){return e.getAttribute("id")},getParent:function(e){var t=e.parentNode;if(!s.getId(t)&&!s._isExtensionPoint(t)){t=t.parentNode}return t},_getLocalName:function(e){return e.localName||e.baseName||e.nodeName},getControlType:function(e){return s._getControlTypeInXml(e)},setAssociation:function(e,t,r){if(typeof r!=="string"){r=s.getId(r)}e.setAttribute(t,r)},getAssociation:function(e,t){return e.getAttribute(t)},getAllAggregations:function(e){var t=s.getControlMetadata(e);return t.getAllAggregations()},getAggregation:function(e,t){var r=s._findAggregationNode(e,t);var n=s._isSingleValueAggregation(e,t);if(!r){if(n&&s._isAltTypeAggregation(e,t)){return s.getProperty(e,t)}return n?undefined:[]}var i=s._getControlsInAggregation(e,r);if(n){return i[0]}if(t==="customData"){var a="http://schemas.sap.com/sapui5/extension/sap.ui.core.CustomData/1";var o;var g=Array.prototype.slice.call(e.attributes).reduce(function(t,r){var n=s._getLocalName(r);if(r.namespaceURI===a){var i=e.ownerDocument.createElementNS("sap.ui.core","CustomData");i.setAttribute("key",n);i.setAttribute("value",r.value);t.push(i)}else if(r.namespaceURI&&r.name.indexOf("xmlns:")!==0){if(!o){o={}}if(!o.hasOwnProperty(r.namespaceURI)){o[r.namespaceURI]={}}o[r.namespaceURI][n]=r.nodeValue}return t},[]);i=i.concat(g);if(o){var u=e.ownerDocument.createElementNS("sap.ui.core","CustomData");u.setAttribute("key","sap-ui-custom-settings");s.setProperty(u,"value",o);i.push(u)}}return i},insertAggregation:function(e,t,r,n,i){var a=s._findAggregationNode(e,t);if(!a){var o=e.namespaceURI;a=s.createControl(o+"."+t,undefined,i);e.appendChild(a)}if(n>=a.childElementCount){a.appendChild(r)}else{var g=s._getControlsInAggregation(e,a)[n];a.insertBefore(r,g)}},removeAggregation:function(e,t,r){var n=s._findAggregationNode(e,t);n.removeChild(r)},removeAllAggregation:function(e,t){var r=s._findAggregationNode(e,t);if(e===r){var n=s._getControlsInAggregation(e,e);n.forEach(function(t){e.removeChild(t)})}else{e.removeChild(r)}},_findAggregationNode:function(e,t){var r;var n=s._children(e);for(var i=0;i<n.length;i++){var a=n[i];if(a.localName===t){r=a;break}}if(!r&&s._isDefaultAggregation(e,t)){r=e}return r},_isDefaultAggregation:function(e,t){var r=s.getControlMetadata(e);var n=r.getDefaultAggregation();return n&&t===n.name},_isNotNamedAggregationNode:function(e,t){var r=s.getAllAggregations(e);var n=r[t.localName];return e.namespaceURI!==t.namespaceURI||!n},_isSingleValueAggregation:function(e,t){var r=s.getAllAggregations(e);var n=r[t];return!n.multiple},_isAltTypeAggregation:function(e,t){var r=s.getControlMetadata(e);var n=r.getAllAggregations()[t];return!!n.altTypes},_isExtensionPoint:function(e){return s._getControlTypeInXml(e)==="sap.ui.core.ExtensionPoint"},getControlMetadata:function(e){return s._getControlMetadataInXml(e)},_getControlsInAggregation:function(e,t){var r=Array.prototype.slice.call(s._children(t));return r.filter(s._isNotNamedAggregationNode.bind(this,e))},_children:function(e){if(e.children){return e.children}else{var t=[];for(var r=0;r<e.childNodes.length;r++){var n=e.childNodes[r];if(n.nodeType===n.ELEMENT_NODE){t.push(n)}}return t}},getBindingTemplate:function(e,t){var r=s._findAggregationNode(e,t);if(r){var n=s._children(r);if(n.length===1){return n[0]}}},updateAggregation:function(e,t){},findIndexInParentAggregation:function(e){var t,r,n;t=s.getParent(e);if(!t){return-1}r=s.getParentAggregationName(e,t);n=s.getAggregation(t,r);if(Array.isArray(n)){n=n.filter(function(e){if(s._isExtensionPoint(e)){return true}return!s.getProperty(e,"stashed")});return n.indexOf(e)}else{return 0}},getParentAggregationName:function(e,t){var r,n;if(!t.isSameNode(e.parentNode)){r=false}else{r=s._isNotNamedAggregationNode(t,e)}if(r){n=s.getControlMetadata(t).getDefaultAggregationName()}else{n=s._getLocalName(e.parentNode)}return n},findAggregation:function(e,t){var r=s.getControlMetadata(e);var n=r.getAllAggregations();if(n){return n[t]}},validateType:function(e,t,r,n,i){var a=t.type;if(t.multiple===false&&s.getAggregation(r,t.name)&&s.getAggregation(r,t.name).length>0){return false}var o=sap.ui.xmlfragment({fragmentContent:n});if(!Array.isArray(o)){o=[o]}var g=s._isInstanceOf(o[i],a)||s._hasInterface(o[i],a);o.forEach(function(e){e.destroy()});return g},instantiateFragment:function(e,t,r){var n;var a=i.parse(e);a=s._checkAndPrefixIdsInFragment(a,t);if(a.localName==="FragmentDefinition"){n=s._getElementNodeChildren(a)}else{n=[a]}n.forEach(function(e){if(s._byId(e.getAttribute("id"),r)){throw Error("The following ID is already in the view: "+e.getAttribute("id"))}});return n},templateControlFragment:function(t,r){return e._templateFragment(t,r).then(function(e){return s._children(e)})},destroy:function(e){var t=e.parentNode;if(t){t.removeChild(e)}},_getFlexCustomData:function(e,t){if(!e){return undefined}return e.getAttributeNS("sap.ui.fl",t)},attachEvent:function(e,t,r,n){if(typeof g.get(r)!=="function"){throw new Error("Can't attach event because the event handler function is not found or not a function.")}var i=s.getProperty(e,t)||"";var u=a.parse(i);var l=r;var f=["$event"];if(n){f.push(JSON.stringify(n))}l+="("+f.join(",")+")";if(!o(u,l)){u.push(l)}e.setAttribute(t,u.join(";"))},detachEvent:function(e,t,r){if(typeof g.get(r)!=="function"){throw new Error("Can't attach event because the event handler function is not found or not a function.")}var n=s.getProperty(e,t)||"";var i=a.parse(n);var o=i.findIndex(function(e){return e.includes(r)});if(o>-1){i.splice(o,1)}if(i.length){e.setAttribute(t,i.join(";"))}else{e.removeAttribute(t)}},bindAggregation:function(e,t,r,n){s.bindProperty(e,t,r.path);s.insertAggregation(e,t,r.template,0,n)},unbindAggregation:function(e,t){if(e.hasAttribute(t)){e.removeAttribute(t);s.removeAllAggregation(e,t)}},getExtensionPointInfo:function(e,t){if(t&&e){var r=Array.prototype.slice.call(t.getElementsByTagNameNS("sap.ui.core","ExtensionPoint"));var n=r.filter(function(t){return t.getAttribute("name")===e});var i=n.length===1?n[0]:undefined;if(i){var a=s.getParent(i);var o={parent:a,aggregationName:s.getParentAggregationName(i,a),index:s.findIndexInParentAggregation(i)+1,defaultContent:Array.prototype.slice.call(s._children(i))};return o}}}});return s},true);