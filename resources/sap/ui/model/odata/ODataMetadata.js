/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./_ODataMetaModelUtils","sap/base/assert","sap/base/Log","sap/base/util/each","sap/base/util/uid","sap/ui/base/EventProvider","sap/ui/core/cache/CacheManager","sap/ui/thirdparty/datajs","sap/ui/thirdparty/jquery"],function(t,e,a,n,i,s,r,o,p){"use strict";var c=s.extend("sap.ui.model.odata.ODataMetadata",{constructor:function(t,e){s.apply(this,arguments);this.bLoaded=false;this.bFailed=false;this.mEntityTypes={};this.mRequestHandles={};this.sUrl=t;this.bAsync=e.async;this.sUser=e.user;this.bWithCredentials=e.withCredentials;this.sPassword=e.password;this.mHeaders=e.headers;this.sCacheKey=e.cacheKey;this.oLoadEvent=null;this.oFailedEvent=null;this.oMetadata=null;this.bMessageScopeSupported=false;this.mNamespaces=e.namespaces||{sap:"http://www.sap.com/Protocols/SAPData",m:"http://schemas.microsoft.com/ado/2007/08/dataservices/metadata","":"http://schemas.microsoft.com/ado/2007/06/edmx"};var n=this;this.pLoadedWithReject=new Promise(function(t,e){n.fnResolve=t;n.fnReject=e});this.pLoaded=this.pLoadedWithReject.catch(function(t){return new Promise(function(t,e){n.fnResolve=t})});function i(t){r.set(n.sCacheKey,JSON.stringify({metadata:n.oMetadata,params:t}))}function o(t){a.error("[ODataMetadata] initial loading of metadata failed");if(t&&t.message){a.error("Error: "+t.message)}}if(this.sCacheKey){r.get(this.sCacheKey).then(function(t){if(t){var e=JSON.parse(t);this.oMetadata=e.metadata;this._handleLoaded(this.oMetadata,e.params,false)}else{this._loadMetadata().then(i).catch(o)}}.bind(this)).catch(o)}else{this._loadMetadata().catch(o)}},metadata:{publicMethods:["getServiceMetadata","attachFailed","detachFailed","attachLoaded","detachLoaded","refresh"]}});c.prototype._setNamespaces=function(t){this.mNamespaces=t};c.prototype._handleLoaded=function(t,e,a){var n=[];this.oMetadata=this.oMetadata?this.merge(this.oMetadata,t,n):t;this.oRequestHandle=null;e.entitySets=n;this.fnResolve(e);if(this.bAsync&&!a){this.fireLoaded(this)}else if(!this.bAsync&&!a){this.bLoaded=true;this.bFailed=false;this.oLoadEvent=setTimeout(this.fireLoaded.bind(this,e),0)}};c.prototype._loadMetadata=function(t,e){var a=this;t=t||this.sUrl;var n=this._createRequest(t);return new Promise(function(t,s){var r;function p(i,s){if(!i||!i.dataServices){var r={message:"Invalid metadata document",request:n,response:s};c(r);return}a.sMetadataBody=s.body;a.oRequestHandle=null;var o={metadataString:a.sMetadataBody};var p=s.headers["Last-Modified"];if(p){o.lastModified=p}var h=s.headers["eTag"];if(h){o.eTag=h}a._handleLoaded(i,o,e);t(o)}function c(t){var n={message:t.message,request:t.request,response:t.response};if(t.response){n.statusCode=t.response.statusCode;n.statusText=t.response.statusText;n.responseText=t.response.body}if(r&&r.bSuppressErrorHandlerCall){return}if(a.bAsync){delete a.mRequestHandles[r.id]}s(n);a.fnReject(n);if(a.bAsync&&!e){a.fireFailed(n)}else if(!a.bAsync&&!e){a.bFailed=true;a.oFailedEvent=setTimeout(a.fireFailed.bind(a,n),0)}}r=o.request(n,p,c,o.metadataHandler);if(a.bAsync){r.id=i();a.mRequestHandles[r.id]=r}})};c.prototype.refresh=function(){return this._loadMetadata()};c.prototype.getServiceMetadata=function(){return this.oMetadata};c.prototype.isLoaded=function(){return this.bLoaded};c.prototype.loaded=function(t){return t?this.pLoadedWithReject:this.pLoaded};c.prototype.isFailed=function(){return this.bFailed};c.prototype.fireLoaded=function(t){this.bLoaded=true;this.bFailed=false;this.fireEvent("loaded",t);a.debug(this+" - loaded was fired");return this};c.prototype.attachLoaded=function(t,e,a){this.attachEvent("loaded",t,e,a);return this};c.prototype.detachLoaded=function(t,e){this.detachEvent("loaded",t,e);return this};c.prototype.fireFailed=function(t){this.bFailed=true;this.fireEvent("failed",t);return this};c.prototype.attachFailed=function(t,e,a){this.attachEvent("failed",t,e,a);return this};c.prototype.detachFailed=function(t,e){this.detachEvent("failed",t,e);return this};c.prototype._getEntityAssociationEnd=function(e,a){var n;if(!this._checkMetadataLoaded()){return null}this._mGetEntityAssociationEndCache=this._mGetEntityAssociationEndCache||{};n=e.namespace+"."+e.name+"/"+a;if(this._mGetEntityAssociationEndCache[n]===undefined){var i=e?t.findObject(e.navigationProperty,a):null,s=i?t.getObject(this.oMetadata.dataServices.schema,"association",i.relationship):null,r=s?t.findObject(s.end,i.toRole,"role"):null;this._mGetEntityAssociationEndCache[n]=r}return this._mGetEntityAssociationEndCache[n]};function h(t){var e={};for(var a=0;a<t.length;a++){var n=t[a];if(n.entityContainer){for(var i=0;i<n.entityContainer.length;i++){var s=n.entityContainer[i];if(s.entitySet){for(var r=0;r<s.entitySet.length;r++){if(s.entitySet[r].name!=null){e[s.entitySet[r].name]=s.entitySet[r]}}}}}}return e}c.prototype._findEntitySetByName=function(t){if(!this.mEntitySets){this.mEntitySets=h(this.oMetadata.dataServices.schema)}return this.mEntitySets[t]};c.prototype._getEntityTypeByPath=function(t){if(!t){e(undefined,"sPath not defined!");return null}if(this.mEntityTypes[t]){return this.mEntityTypes[t]}if(!this._checkMetadataLoaded()){return null}var a=t.replace(/^\/|\/$/g,""),n=a.split("/"),i=n.length,s,r,o,p,c=this;if(n[0].indexOf("(")!=-1){n[0]=n[0].substring(0,n[0].indexOf("("))}if(i>1){s=c._getEntityTypeByPath(n[0]);for(var h=1;h<n.length;h++){if(s){if(n[h].indexOf("(")!=-1){n[h]=n[h].substring(0,n[h].indexOf("("))}p=c._getEntityTypeByNavProperty(s,n[h]);if(p){s=p}o=s}}}else{r=this._splitName(this._getEntityTypeName(n[0]));o=this._getObjectMetadata("entityType",r.name,r.namespace);if(o){o.entityType=this._getEntityTypeName(n[0])}}if(!o){var f=n[n.length-1];var y=this._getFunctionImportMetadata(f,"GET");if(!y){y=this._getFunctionImportMetadata(f,"POST")}if(y&&y.entitySet){o=Object.assign({},this._getEntityTypeByPath(y.entitySet));if(o){o.entityType=this._getEntityTypeName(y.entitySet);o.isFunction=true}}}if(o){this.mEntityTypes[t]=o}return o};c.prototype._getEntityTypeByName=function(t){var a,n=this,i,s,r;if(!t){e(undefined,"sName not defined!");return null}r=this._splitName(t);s=r.namespace;i=r.name;if(!this._checkMetadataLoaded()){return null}if(this.mEntityTypes[t]){a=this.mEntityTypes[t]}else{p.each(this.oMetadata.dataServices.schema,function(e,r){if(r.entityType&&(!s||r.namespace===s)){p.each(r.entityType,function(e,s){if(s.name===i){a=s;n.mEntityTypes[t]=a;a.namespace=r.namespace;return false}})}})}return a};c.prototype._checkMetadataLoaded=function(){if(!this.oMetadata||p.isEmptyObject(this.oMetadata)){e(undefined,"No metadata loaded!");return false}return true};c.prototype._getAnnotation=function(t){var a,n,i,s,r,o,p;n=t.split("/#");s=n[1].split("/");if(!n[0]){r=this._getEntityTypeByName(s[0]);e(r,s[0]+" is not a valid EntityType");if(!r){return}o=n[1].substr(n[1].indexOf("/")+1);p=this._getPropertyMetadata(r,o);e(p,o+" is not a valid property path");if(!p){return}i=o.substr(o.indexOf(p.name));i=i.substr(i.indexOf("/")+1)}else{r=this._getEntityTypeByPath(n[0]);e(r,n[0]+" is not a valid path");if(!r){return}t=n[0].replace(/^\/|\/$/g,"");o=t;while(!p&&o.indexOf("/")>0){o=o.substr(o.indexOf("/")+1);p=this._getPropertyMetadata(r,o)}e(p,o+" is not a valid property path");if(!p){return}i=s.join("/")}a=this._getAnnotationObject(r,p,i);return a};c.prototype._getAnnotationObject=function(t,e,a){var n,i,s,r,o;if(!e){return}r=e;i=a.split("/");if(i[0].indexOf(".")>-1){return this._getV4AnnotationObject(t,e,i)}else{if(i.length>1){r=r[i[0]];if(!r&&e.extensions){for(var p=0;p<e.extensions.length;p++){var c=e.extensions[p];if(c.name==i[0]){r=c;break}}}a=i.splice(0,1);s=this._getAnnotationObject(t,r,i.join("/"))}else{if(i[0].indexOf("@")>-1){o=i[0].substr(1);n=o.split(":");s=r[n[0]];if(!s&&r.extensions){for(var p=0;p<r.extensions.length;p++){var c=r.extensions[p];if(c.name===n[1]&&c.namespace===this.mNamespaces[n[0]]){s=c.value;break}}}}else{n=i[0].split(":");s=r[n[0]];s=r[i[0]];if(!s&&r.extensions){for(var p=0;p<r.extensions.length;p++){var c=r.extensions[p];if(c.name===n[1]&&c.namespace===this.mNamespaces[n[0]]){s=c;break}}}}}}return s};c.prototype._getV4AnnotationObject=function(t,a,n){var i,s=[];if(n.length>1){e(n.length==1,"'"+n.join("/")+"' is not a valid annotation path");return}var r=t.namespace?t.namespace+".":"";r+=t.name+"/"+a.name;p.each(this.oMetadata.dataServices.schema,function(t,e){if(e.annotations){p.each(e.annotations,function(t,e){if(e.target===r&&!e.qualifier){s.push(e.annotation);return false}})}});if(s){p.each(s,function(t,e){p.each(e,function(t,e){if(e.term===n[0]){i=e}})})}return i};c.prototype._splitName=function(t){var e={};if(t){var a=t.lastIndexOf(".");e.name=t.substr(a+1);e.namespace=t.substr(0,a)}return e};c.prototype._getEntityTypeName=function(t){var e,a;if(t){a=this._findEntitySetByName(t);if(a){e=a.entityType}}return e};c.prototype._getObjectMetadata=function(t,e,a){var n;if(e&&a){p.each(this.oMetadata.dataServices.schema,function(i,s){if(s[t]&&s.namespace===a){p.each(s[t],function(t,a){if(a.name===e){n=a;n.namespace=s.namespace;return false}});return!n}})}return n};c.prototype.getUseBatch=function(){var t=false;p.each(this.oMetadata.dataServices.schema,function(e,a){if(a.entityContainer){p.each(a.entityContainer,function(e,a){if(a.extensions){p.each(a.extensions,function(e,a){if(a.name==="use-batch"&&a.namespace==="http://www.sap.com/Protocols/SAPData"){t=typeof a.value==="string"?a.value.toLowerCase()==="true":!!a.value;return false}})}})}});return t};c.prototype._getFunctionImportMetadataIterate=function(t,e){var a=[];n(this.oMetadata.dataServices.schema,function(i,s){if(s["entityContainer"]){n(s["entityContainer"],function(i,s){if(s["functionImport"]){n(s["functionImport"],function(n,i){if(t(i)){a.push(i);if(e){return false}}})}return!(e&&a.length===1)})}return!(e&&a.length===1)});return a};c.prototype._getFirstMatchingFunctionImportMetadata=function(t){var e=this._getFunctionImportMetadataIterate(t,true);return e.length===1?e[0]:null};c.prototype._getFunctionImportMetadataByName=function(t){if(t.indexOf("/")>-1){t=t.substr(t.indexOf("/")+1)}return this._getFunctionImportMetadataIterate(function(e){return e.name===t})};c.prototype._getFunctionImportMetadata=function(t,e){if(t.indexOf("/")>-1){t=t.substr(t.indexOf("/")+1)}return this._getFirstMatchingFunctionImportMetadata(function(a){return a.name===t&&a.httpMethod===e})};c.prototype._getEntityTypeByNavProperty=function(t,e){if(!t.navigationProperty){return undefined}for(var a=0;a<t.navigationProperty.length;++a){var n=t.navigationProperty[a];if(n.name===e){return this._getEntityTypeByNavPropertyObject(n)}}return undefined};c.prototype._getEntityTypeByNavPropertyObject=function(t){var e;var a=this._splitName(t.relationship);var n=this._getObjectMetadata("association",a.name,a.namespace);if(n){var i=n.end[0];if(i.role!==t.toRole){i=n.end[1]}var s=this._splitName(i.type);e=this._getObjectMetadata("entityType",s.name,s.namespace);if(e){e.entityType=i.type}}return e};c.prototype._getNavigationPropertyNames=function(t){var e=[];if(t.navigationProperty){p.each(t.navigationProperty,function(t,a){e.push(a.name)})}return e};c.prototype._getNavPropertyRefInfo=function(t,e){var a,i,s,r,o,p,c,h,f,y,d,u=this;n(t.navigationProperty,function(n,l){s=u._splitName(l.relationship);i=u._getObjectMetadata("association",s.name,s.namespace);if(!i||!i.referentialConstraint){return}p=i.referentialConstraint.dependent;f=i.end.find(function(t){return t.role===p.role});if(f.type!==t.namespace+"."+t.name){return}c=p.propertyRef.some(function(t){return t.name===e});if(!c){return}o=i.referentialConstraint.principal;h=o.role;r=u._getAssociationSetByAssociation(l.relationship);f=r.end.find(function(t){return t.role===h});y=f.entitySet;d=o.propertyRef.map(function(t){return t.name});a={name:l.name,entitySet:y,keys:d}});return a};c.prototype._getPropertyMetadata=function(t,e){var a,n=this;if(!t){return}e=e.replace(/^\/|\/$/g,"");var i=e.split("/");p.each(t.property,function(t,e){if(e.name===i[0]){a=e;return false}});if(i.length>1){if(!a){while(t&&i.length>1){t=this._getEntityTypeByNavProperty(t,i[0]);i.shift()}if(t){a=n._getPropertyMetadata(t,i[0])}}else if(!a.type.toLowerCase().startsWith("edm.")){var s=this._splitName(a.type);a=this._getPropertyMetadata(this._getObjectMetadata("complexType",s.name,s.namespace),i[1])}}return a};c.prototype.destroy=function(){delete this.oMetadata;var t=this;p.each(this.mRequestHandles,function(e,a){a.bSuppressErrorHandlerCall=true;a.abort();delete t.mRequestHandles[e]});if(!!this.oLoadEvent){clearTimeout(this.oLoadEvent)}if(!!this.oFailedEvent){clearTimeout(this.oFailedEvent)}s.prototype.destroy.apply(this,arguments)};c.prototype._fillElementCaches=function(){var t=this;if(this._entitySetMap||!this._checkMetadataLoaded()){return}this._entitySetMap={};this.oMetadata.dataServices.schema.forEach(function(e){(e.entityContainer||[]).forEach(function(e){(e.entitySet||[]).forEach(function(e){var a=t._getEntityTypeByName(e.entityType);a.__navigationPropertiesMap={};(a.navigationProperty||[]).forEach(function(t){a.__navigationPropertiesMap[t.name]=t});e.__entityType=a;t._entitySetMap[e.entityType]=e})})})};c.prototype._createRequest=function(t){var e={"sap-cancel-on-close":true},a={"Accept-Language":sap.ui.getCore().getConfiguration().getLanguageTag()};p.extend(e,this.mHeaders,a);var n={headers:e,requestUri:t,method:"GET",user:this.sUser,password:this.sPassword,async:this.bAsync};if(this.bAsync){n.withCredentials=this.bWithCredentials}return n};c.prototype._getEntitySetByPath=function(t){var e;this._fillElementCaches();e=this._getEntityTypeByPath(t);if(e){return this._entitySetMap[e.entityType]}};c.prototype._addUrl=function(t){var e=[].concat(t);return Promise.all(e.map(function(t){return this._loadMetadata(t,true)},this))};c.prototype.merge=function(t,e,a){var n=this;if(this.mEntitySets){delete this.mEntitySets}p.each(t.dataServices.schema,function(t,i){p.each(e.dataServices.schema,function(t,e){if(e.namespace===i.namespace){if(e.entityType){if(!n.mEntityTypeNames){n.mEntityTypeNames={};i.entityType.map(function(t){n.mEntityTypeNames[t.name]=true})}i.entityType=!i.entityType?[]:i.entityType;for(var s=0;s<e.entityType.length;s++){if(!(e.entityType[s].name in n.mEntityTypeNames)){i.entityType.push(e.entityType[s]);n.mEntityTypeNames[e.entityType[s].name]=true}}}if(i.entityContainer&&e.entityContainer){p.each(i.entityContainer,function(t,i){p.each(e.entityContainer,function(t,e){if(e.entitySet){if(e.name===i.name){if(!n.mEntitySetNames){n.mEntitySetNames={};i.entitySet.map(function(t){n.mEntitySetNames[t.name]=true})}i.entitySet=!i.entitySet?[]:i.entitySet;for(var s=0;s<e.entitySet.length;s++){if(!(e.entitySet[s].name in n.mEntitySetNames)){i.entitySet.push(e.entitySet[s]);n.mEntitySetNames[e.entitySet[s].name]=true}}e.entitySet.forEach(function(t){a.push(t)})}}})})}if(e.annotations){i.annotations=!i.annotations?[]:i.annotations;i.annotations=i.annotations.concat(e.annotations)}}})});return t};c.prototype._getEntitySetByType=function(t){var e=t.namespace+"."+t.name;var a=this.oMetadata.dataServices.schema;for(var n=0;n<a.length;++n){var i=a[n].entityContainer;if(i){for(var s=0;s<i.length;++s){var r=i[s].entitySet;if(r){for(var o=0;o<r.length;++o){if(r[o].entityType===e){return r[o]}}}}}}return null};c.prototype._calculateCanonicalPath=function(t){var e,a,n,i;if(t){a=t.lastIndexOf(")");if(a!==-1){i=t.substr(0,a+1);var s=this._getEntitySetByPath(i);if(s){if(s.__entityType.isFunction){e=t}else{n=t.split("/");if(i==="/"+n[1]){if(!(n[2]in s.__entityType.__navigationPropertiesMap)){e=t}}else{n=i.split("/");i="/"+s.name+n[n.length-1].substr(n[n.length-1].indexOf("("))+t.substr(a+1);if(i!==t){e=i}}}}}}return e};c.prototype._getAssociationSetByAssociation=function(t){var e=this.oMetadata.dataServices.schema;for(var a=0;a<e.length;++a){var n=e[a].entityContainer;if(n){for(var i=0;i<n.length;++i){var s=n[i].associationSet;if(s){for(var r=0;r<s.length;++r){if(s[r].association===t){return s[r]}}}}}}return null};c.prototype._isMessageScopeSupported=function(){var t=this.oMetadata.dataServices.schema,e,a;if(!this.bMessageScopeSupported&&t){for(var n=0;n<t.length;++n){a=t[n].entityContainer;if(a){for(var i=0;i<a.length;++i){e=a[i];if(e.extensions&&Array.isArray(e.extensions)){for(var s=0;s<e.extensions.length;++s){if(e.extensions[s].name==="message-scope-supported"&&e.extensions[s].namespace===this.mNamespaces.sap){if(e.extensions[s].value==="true"){this.bMessageScopeSupported=true;break}}}}}}}}return this.bMessageScopeSupported};c.prototype._isCollection=function(t){var e=false;var a=t.lastIndexOf("/");if(a>0){var n=t.substring(0,a);var i=this._getEntityTypeByPath(n);if(i){var s=this._getEntityAssociationEnd(i,t.substring(a+1));if(s&&s.multiplicity==="*"){e=true}}}else{e=true}return e};c.prototype._getReducedPath=function(t){var e,a,n,i,s,r,o,p=t.split("/"),c;if(p.length<4){return t}this._fillElementCaches();for(a=1;a<p.length-2;a+=1){c=this._getEntityTypeByPath(p.slice(0,a+1).join("/"));s=c&&c.__navigationPropertiesMap[p[a+1].split("(")[0]];if(!s){continue}o=p[a+2].split("(")[0];i=this._getEntityTypeByNavPropertyObject(s);r=i&&i.__navigationPropertiesMap[o];if(!r||s.relationship!==r.relationship){continue}n=p[a+2].slice(o.length);e=this._getEntityAssociationEnd(i,o);if(e.multiplicity!=="*"||n&&p[a].endsWith(n)){p.splice(a+1,2);return this._getReducedPath(p.join("/"))}}return p.join("/")};c.prototype.getKeyPropertyNamesByPath=function(t){var e,a,n=t.lastIndexOf("/");if(n>0){a=this._getEntityTypeByPath(t.slice(0,n));if(a){e=this._getEntityAssociationEnd(a,t.slice(n+1).split("(")[0]);a=e?this._getEntityTypeByName(e.type):undefined}}else{a=this._getEntityTypeByPath(t)}if(a){return a.key.propertyRef.map(function(t){return t.name})}};return c});