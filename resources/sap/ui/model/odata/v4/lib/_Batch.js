/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./_Helper","sap/base/strings/escapeRegExp"],function(e,n){"use strict";var r={POST:true,PUT:true,PATCH:true,DELETE:true},t,i=/^\$\d+/,o=/(\S*?)=(?:"(.+)"|(\S+))/;function a(e){var r=s(e,"boundary"),t=e.trim().indexOf("multipart/mixed");if(t!==0||!r){throw new Error('Invalid $batch response header "Content-Type": '+e)}r=n(r);return new RegExp("--"+r+"(?:[ \t]*\r\n|--)")}function s(e,n){var r,t=e.split(";"),i;n=n.toLowerCase();for(r=1;r<t.length;r+=1){i=o.exec(t[r]);if(i[1].toLowerCase()===n){return i[2]||i[3]}}}function c(e){var n=f(e,"content-type");return n.indexOf("multipart/mixed;")===0?n:undefined}function u(e){var n=f(e,"content-id"),r;if(!n){throw new Error("Content-ID MIME header missing for the change set response.")}r=parseInt(n);if(isNaN(r)){throw new Error("Invalid Content-ID value in change set response.")}return r}function f(e,n){var r,t,i=e.split("\r\n");for(r=0;r<i.length;r+=1){t=i[r].split(":");if(t[0].toLowerCase().trim()===n){return t[1].trim()}}}function d(e,n,r){var t=n.split(a(e)),i=[];t=t.slice(1,-1);t.forEach(function(e){var n,t,o,a,f,h,p,l,y,m,T,E,w,C={},v;w=e.indexOf("\r\n\r\n");E=e.slice(0,w);y=e.indexOf("\r\n\r\n",w+4);l=e.slice(w+4,y);n=c(E);if(n){i.push(d(n,e.slice(w+4),true));return}p=l.split("\r\n");m=p[0].split(" ");C.status=parseInt(m[1]);C.statusText=m.slice(2).join(" ");C.headers={};for(T=1;T<p.length;T+=1){a=p[T];o=a.indexOf(":");f=a.slice(0,o).trim();h=a.slice(o+1).trim();C.headers[f]=h;if(f.toLowerCase()==="content-type"){t=s(h,"charset");if(t&&t.toLowerCase()!=="utf-8"){throw new Error('Unsupported "Content-Type" charset: '+t)}}}C.responseText=e.slice(y+4,-2);if(r){v=u(E);i[v]=C}else{i.push(C)}});return i}function h(e){var n,r=[];for(n in e){r=r.concat(n,":",e[n],"\r\n")}return r}function p(n,t){var o=(t!==undefined?"changeset_":"batch_")+e.uid(),a=t!==undefined,s=[];if(a){s=s.concat("Content-Type: multipart/mixed;boundary=",o,"\r\n\r\n")}n.forEach(function(n,c){var u="",f=n.url;if(a){u="Content-ID:"+c+"."+t+"\r\n"}s=s.concat("--",o,"\r\n");if(Array.isArray(n)){if(a){throw new Error("Change set must not contain a nested change set.")}s=s.concat(p(n,c).body)}else{if(a&&!r[n.method]){throw new Error("Invalid HTTP request method: "+n.method+". Change set must contain only POST, PUT, PATCH or DELETE requests.")}if(t!==undefined&&f[0]==="$"){f=f.replace(i,"$&."+t)}s=s.concat("Content-Type:application/http\r\n","Content-Transfer-Encoding:binary\r\n",u,"\r\n",n.method," ",f," HTTP/1.1\r\n",h(e.resolveIfMatchHeader(n.headers)),"\r\n",JSON.stringify(n.body)||"","\r\n")}});s=s.concat("--",o,"--\r\n");return{body:s,batchBoundary:o}}t={deserializeBatchResponse:function(e,n){return d(e,n,false)},serializeBatchRequest:function(e){var n=p(e);return{body:n.body.join(""),headers:{"Content-Type":"multipart/mixed; boundary="+n.batchBoundary,"MIME-Version":"1.0"}}}};return t},false);