/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/ui/base/BindingParser","sap/ui/performance/Measurement","sap/ui/thirdparty/jquery"],function(e,t,a,r){"use strict";var i="sap.ui.model.odata.AnnotationHelper",n=/[\\\{\}:]/,o,u=/^(\/dataServices\/schema\/\d+\/entityContainer\/\d+\/entitySet\/\d+)(?:\/|$)/,d=[i],s=i+"/followPath",p=/^(\/dataServices\/schema\/\d+\/(?:complex|entity)Type\/\d+)(?:\/|$)/,l={"Edm.Boolean":"sap.ui.model.odata.type.Boolean","Edm.Byte":"sap.ui.model.odata.type.Byte","Edm.Date":"sap.ui.model.odata.type.Date","Edm.DateTime":"sap.ui.model.odata.type.DateTime","Edm.DateTimeOffset":"sap.ui.model.odata.type.DateTimeOffset","Edm.Decimal":"sap.ui.model.odata.type.Decimal","Edm.Double":"sap.ui.model.odata.type.Double","Edm.Float":"sap.ui.model.odata.type.Single","Edm.Guid":"sap.ui.model.odata.type.Guid","Edm.Int16":"sap.ui.model.odata.type.Int16","Edm.Int32":"sap.ui.model.odata.type.Int32","Edm.Int64":"sap.ui.model.odata.type.Int64","Edm.SByte":"sap.ui.model.odata.type.SByte","Edm.Single":"sap.ui.model.odata.type.Single","Edm.String":"sap.ui.model.odata.type.String","Edm.Stream":"sap.ui.model.odata.type.Stream","Edm.Time":"sap.ui.model.odata.type.Time","Edm.TimeOfDay":"sap.ui.model.odata.type.TimeOfDay"};o={descend:function(e,t,a){var i=r.extend({},e);o.expectType(e,typeof t==="number"?"array":"object");i.path=e.path+"/"+t;i.value=e.value[t];if(a===true){i.asExpression=true}else if(a){o.expectType(i,a)}return i},error:function(t,a,r){a=t.path+": "+a;e.error(a,o.toErrorString(t.value),r||i);throw new SyntaxError(a)},expectType:function(e,t){var a,r=e.value;if(t==="array"){a=!Array.isArray(r)}else{a=typeof r!==t||r===null||Array.isArray(r)}if(a){o.error(e,"Expected "+t)}},followPath:function(e,t){var r,i,n,u,p=e.getModel(),l,f={associationSetEnd:undefined,navigationAfterMultiple:false,isMultiple:false,navigationProperties:[],resolvedPath:undefined},m,y;a.average(s,"",d);i=o.getPath(t);n=i!==undefined&&o.getStartingPoint(e,i);if(!n){a.end(s);return undefined}l=i.split("/");while(i&&l.length&&n){m=l[0];u=m.indexOf("@");if(u===0){n+="/"+m.slice(1);l.shift();continue}y=p.getObject(n);r=p.getODataAssociationEnd(y,m);if(r){f.associationSetEnd=p.getODataAssociationSetEnd(y,m);f.navigationProperties.push(m);if(f.isMultiple){f.navigationAfterMultiple=true}f.isMultiple=r.multiplicity==="*";n=p.getODataEntityType(r.type,true);l.shift();continue}n=p.getODataProperty(y,l,true)}f.resolvedPath=n;a.end(s);return f},getPath:function(e){if(e){if(e.hasOwnProperty("AnnotationPath")){return e.AnnotationPath}if(e.hasOwnProperty("Path")){return e.Path}if(e.hasOwnProperty("PropertyPath")){return e.PropertyPath}if(e.hasOwnProperty("NavigationPropertyPath")){return e.NavigationPropertyPath}}return undefined},getStartingPoint:function(e,t){var a,r=p.exec(e.getPath()),i;if(r){return r[1]}r=u.exec(e.getPath());if(r){if(!t){return r[1]}i=e.getModel();a=i.getObject(r[1]);return i.getODataEntityType(a.entityType,true)}return undefined},property:function(e,t,a){return o.descend(e,t,a).value},resultToString:function(e,a,r){var i=e.value;function u(t){var a,r,u=e.parameters&&o.toJSON(e.parameters),d=u&&u!=="{}",s,p=l[e.type];t=t&&!e.ignoreTypeInPath&&p;if(t||n.test(i)||d){s="{path:"+o.toJSON(i);if(t){s+=",type:'"+p+"'";a=o.toJSON(e.constraints);if(a&&a!=="{}"){s+=",constraints:"+a}r=e.formatOptions&&o.toJSON(e.formatOptions);if(r&&r!=="{}"){s+=",formatOptions:"+r}}if(d){s+=",parameters:"+u}return s+"}"}return"{"+i+"}"}function d(e){switch(e.type){case"Edm.Boolean":case"Edm.Double":case"Edm.Int32":return String(e.value);default:return o.toJSON(e.value)}}switch(e.result){case"binding":return(a?"$":"")+u(r);case"composite":if(a){throw new Error("Trying to embed a composite binding into an expression binding")}return i;case"constant":if(e.type==="edm:Null"){return a?"null":null}if(a){return d(e)}return typeof i==="string"?t.complexParser.escape(i):String(i);case"expression":return a?i:"{="+i+"}"}},toErrorString:function(e){var t;if(typeof e!=="function"){try{t=o.toJSON(e);if(t!==undefined&&t!=="null"){return t}}catch(e){}}return String(e)},toJSON:function(e){var t,a=false,r="",i,n;t=JSON.stringify(e);if(t===undefined){return undefined}for(i=0;i<t.length;i+=1){switch(n=t.charAt(i)){case"'":r+="\\'";break;case'"':if(a){r+=n;a=false}else{r+="'"}break;case"\\":if(a){r+="\\\\"}a=!a;break;default:if(a){r+="\\";a=false}r+=n}}return r}};return o},false);