/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/test/_OpaLogger","sap/ui/test/_ParameterValidator","sap/ui/test/autowaiter/_utils","sap/ui/thirdparty/jquery"],function(t,e,a,i){"use strict";var r=t.getLogger("sap.ui.test.autowaiter._timeoutWaiter");var n=t.getLogger("sap.ui.test.autowaiter._timeoutWaiter#hasPending");var u=new e({errorPrefix:"sap.ui.test.autowaiter._timeoutWaiter#extendConfig"});var o={};var c=1;var s=1e3;var l=10;var f={maxDepth:c,maxDelay:s,minDelay:l};var d={TRACKED:"TRACKED",STARTER:"STARTED",FINISHED:"FINISHED",CLEARED:"CLEARED"};var m;function D(t){var e="set"+t;var i="clear"+t;var n=window[e];if(!n){return}var u=window[i];window[e]=function t(e,i,u){i=i||0;var c=Array.prototype.slice.call(arguments,2);var s={delay:i,initiator:m,func:a.functionToString(e),stack:a.resolveStackTrace(),status:d.TRACKED};var l;if(u&&u==="TIMEOUT_WAITER_IGNORE"){l=n.apply(null,[e,i].concat(c.slice(1)));r.trace("Timeout with ID "+l+" should not be tracked. "+" Delay: "+i+" Initiator: "+m);return l}var f=function t(){var a=o[l];if(!a){r.trace("Timeout data for timeout with ID "+l+" disapered unexpectedly");a={}}m=l;r.trace("Timeout with ID "+l+" started");a.status=d.STARTED;try{e()}finally{m=undefined}r.trace("Timeout with ID "+l+" finished");a.status=d.FINISHED};l=n.apply(null,[f,i].concat(c));r.trace("Timeout with ID "+l+" is tracked. "+" Delay: "+i+" Initiator: "+m);o[l]=s;return l};window[i]=function t(e){if(!e){r.trace("Could not clean timeout with invalid ID: "+e);return}var a=o[e];if(!a){r.trace("Timeout data for timeout with ID "+e+" disapered unexpectedly or timeout was not tracked intentionally");a={}}a.status=d.CLEARED;r.trace("Timeout with ID "+e+" cleared");u(e)}}D("Timeout");D("Immediate");function v(t,e,a,i){return"\nTimeout: ID: "+t+" Type: "+(a?"BLOCKING":"NOT BLOCKING")+" Status: "+e.status+" Delay: "+e.delay+" Initiator: "+e.initiator+(i?"\nFunction: "+e.func:"")+(i?"\nStack: "+e.stack:"")}function y(t){var e=Object.keys(o);var a="Found "+t.length+" blocking out of "+e.length+" tracked timeouts";t.forEach(function(e){a+=v(e,o[e],t.some(function(t){return t==e}),true)});n.debug(a);var i="Tracked timeouts";e.forEach(function(e){i+=v(e,o[e],t.some(function(t){return t==e}),true)});n.trace(i)}function T(t){var e=o[t];if(e.status!==d.TRACKED){return false}if(e.delay>f.maxDelay){return false}if(e.delay>f.minDelay){return p(t)}return true}function p(t,e){e=e||1;var a=o[t];if(a.initiator&&o[a.initiator]){if(a.delay==o[a.initiator].delay){if(e>=f.maxDepth){return false}return p(a.initiator,e+1)}}return true}return{hasPending:function(){var t=Object.keys(o).filter(function(t){return T(t)});var e=t.length>0;y(t);return e},extendConfig:function(t){t=t&&t.timeoutWaiter||{maxDepth:c,maxDelay:s};u.validate({inputToValidate:t,validationInfo:{maxDepth:"numeric",maxDelay:"numeric",minDelay:"numeric"}});i.extend(f,t)}}},true);