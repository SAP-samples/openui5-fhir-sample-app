/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/changeHandler/Base","sap/ui/fl/changeHandler/ChangeHandlerMediator","sap/base/Log","sap/base/util/merge","sap/base/util/ObjectPath"],function(e,t,n,r,o){"use strict";function i(e){return o.get("content.createFunction",e)}function a(e,t){var n=e.content;if(n){return e.content.newFieldSelector&&e.content.newFieldIndex!==undefined&&e.content.bindingPath&&e.content.oDataServiceVersion&&!!i(t)}return false}function l(e){return e+"-field"}function d(e,t){var n=r({},e);n.fieldSelector.id=l(n.fieldSelector.id);return t.createControlForProperty(n).then(function(n){var r=e.modifier.getId(n.control);e.labelFor=r;return t.createLabel(e).then(function(e){return{label:e,control:n.control,valueHelp:n.valueHelp}})})}function c(e,t){var n=r({aggregationName:"formElements",payload:e.payload},t);var i;return new Promise(function(t){sap.ui.require([e.name],t)}).then(function(e){i=e}).then(function(){if(i.createLayout){return i.createLayout(n)}}).then(function(e){if(o.get("control",e)){e.layoutControl=true;return e}return d(n,i)})}function f(e,o){var d=r({},o);d.fieldSelector.id=l(d.fieldSelector.id);return t.getChangeHandlerSettings({scenario:"addODataFieldWithLabel",oDataServiceVersion:e.content&&e.content.oDataServiceVersion}).then(function(t){if(a(e,t)){var r=i(t);return r(d.modifier,d)}else{n.error("Change does not contain sufficient information to be applied or ChangeHandlerMediator could not be retrieved: ["+e.layer+"]"+e.namespace+"/"+e.fileName+"."+e.fileType)}})}var u={};u.applyChange=function(t,n,r){var o=t.getDefinition();var i=r.view;var a=o.content.newFieldIndex;var l=r.appComponent;var d=o.content;var u=d.newFieldSelector;var g=d.bindingPath;var p={appComponent:r.appComponent,view:r.view,fieldSelector:u,bindingPath:g,modifier:r.modifier,element:n};if(r.modifier.bySelector(u,l)){return e.markAsNotApplicable("Control to be created already exists:"+u)}var v={newFieldSelector:u};var s=r.modifier.getFlexDelegate(n);var m=s?c(s,p):f(o,p);return m.then(function(e){var n;if(!e.layoutControl){n=r.modifier.createControl("sap.ui.layout.form.FormElement",l,i,u);r.modifier.insertAggregation(n,"label",e.label,0,i);r.modifier.insertAggregation(n,"fields",e.control,0,i)}else{n=e.control}var o=t.getDependentControl("parentFormContainer",r);r.modifier.insertAggregation(o,"formElements",n,a,i);if(e.valueHelp){r.modifier.insertAggregation(o,"dependents",e.valueHelp,0,i);var d=r.modifier.getSelector(r.modifier.getId(e.valueHelp),l);v.valueHelpSelector=d}t.setRevertData(v);return true})};u.completeChangeContent=function(e,t,n){var r=n.appComponent;var o=e.getDefinition();if(!o.content){o.content={}}if(t.parentId){e.addDependentControl(t.parentId,"parentFormContainer",n)}else{throw new Error("oSpecificChangeInfo.parentId attribute required")}if(t.bindingPath){o.content.bindingPath=t.bindingPath}else{throw new Error("oSpecificChangeInfo.bindingPath attribute required")}if(t.newControlId){o.content.newFieldSelector=n.modifier.getSelector(t.newControlId,r)}else{throw new Error("oSpecificChangeInfo.newControlId attribute required")}if(t.index===undefined){throw new Error("oSpecificChangeInfo.targetIndex attribute required")}else{o.content.newFieldIndex=t.index}if(t.oDataServiceVersion){o.content.oDataServiceVersion=t.oDataServiceVersion}};u.revertChange=function(e,t,n){var r=n.appComponent;var o=n.view;var i=n.modifier;var a=e.getRevertData().newFieldSelector;var l=e.getRevertData().valueHelpSelector;var d=i.bySelector(a,r,o);var c=e.getDependentControl("parentFormContainer",n);i.removeAggregation(c,"formElements",d);i.destroy(d);if(l){var f=i.bySelector(l,r,o);i.removeAggregation(c,"dependents",f);i.destroy(f)}e.resetRevertData();return true};return u},true);