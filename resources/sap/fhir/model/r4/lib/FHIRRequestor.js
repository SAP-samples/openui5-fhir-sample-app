/*!
 * SAP SE
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/fhir/model/r4/FHIRUtils","sap/fhir/model/r4/SubmitMode","sap/fhir/model/r4/lib/FHIRBundle","sap/fhir/model/r4/lib/FHIRBundleEntry","sap/fhir/model/r4/lib/FHIRBundleRequest","sap/fhir/model/r4/lib/FHIRBundleType","sap/fhir/model/r4/lib/RequestHandle","sap/fhir/model/r4/lib/HTTPMethod","sap/fhir/model/r4/lib/FHIRUrl","sap/base/util/each","sap/base/util/merge","sap/fhir/model/r4/lib/FHIROperationOutcome"],function(e,t,r,s,i,n,o,u,a,l,d,h,f){"use strict";var p=function(e,t,r,s,i){this._mBundleQueue={};this.oModel=t;this._sServiceUrl=e;this._aPendingRequestHandles=[];this.bCSRF=!!r;this.sPrefer=s?"return=minimal":s;this.oDefaultQueryParams=i;this._oRegex={rAmpersand:/&/g,rEquals:/\=/g,rHash:/#/g,rPlus:/\+/g}};p.prototype.submitBundle=function(e,t,r){var s=this._mBundleQueue[e];return this._sendBundle(s,t,r)};p.prototype._request=function(e,s,i,n,o,a,l,d,h,f,p){if(!t.isRequestable(s)&&!i){return undefined}var c;if(!i&&this._getGroupSubmitMode(o)!==r.Direct){var g=this._getBundleByGroup(o);var _=this._getGroupUri(o);var m=this._createBundleEntry(e,s,n,l,d,h,f,_);g.addBundleEntry(m);if(p){this._mBundleQueue[o]=g;return g}else{c=this._mBundleQueue[o];if(c&&c instanceof u){c.getRequest().abort()}c=this._sendBundle(g);this._mBundleQueue[o]=c;return c}}c=this._sendRequest(e,s,n,a,l,d,h,f);return c};p.prototype._createBundleEntry=function(e,r,s,o,u,l,d,h){if(r&&r.charAt(0)==="/"){r=r.slice(1)}var f=e===a.POST?this.oModel.getBindingInfo("/"+r,undefined,false,o):this.oModel.getBindingInfo("/"+r);var p=r+(a.GET===e?this._buildQueryParameters(s,f,e):"");var c;var g;if(a.GET!==e){c=t.generateFullUrl(h,f.getResourceServerPath(),f.getResourceId(),this._sServiceUrl);g=f.getETag()}var _=new n(d,e,p,u,l,g);var m=new i(c,o,_);return m};p.prototype._sendBundle=function(e,t,r){var s=function(s,i){var n=[];var o=[];this._deleteBundleFromQueue(e.getGroupId());for(var u=0;u<s.getNumberOfBundleEntries();u++){var a=s.getBundlyEntry(u);var l=i.getRequest().responseJSON.entry[u];if(l&&l.response.status.startsWith("2")){if(l.resource){n.push(l.resource)}else if(a.getResource()){n.push(a.getResource())}a.getRequest().executeSuccessCallback(i,l,a)}else{if(l&&l.response.outcome){o.push(new f(l.response.outcome))}a.getRequest().executeErrorCallback(i,l,a)}}if(r&&o.length>0){r(i,n,o)}else if(t){t(n)}}.bind(this,e);var i=function(t,s){this._deleteBundleFromQueue(e.getGroupId());for(var i=0;i<t.getNumberOfBundleEntries();i++){var n=t.getBundlyEntry(i);n.getRequest().executeErrorCallback(s)}if(r){r(s)}}.bind(this,e);var n=this._sendRequest(a.POST,"",{},{},e.getBundleData(),s,i);n.setBundle(e);return n};p.prototype._sendRequest=function(e,r,s,i,n,o,d,h){var f=new u(h);var p=new l(r,this._sServiceUrl);var c;var g="application/json";var _=this.oModel.getBindingInfo(p.getRelativeUrlWithoutQueryParameters());if(this._isRequestTransformable(e,p)){e=a.POST;n=this._getFormData(s,_,p.getQueryParameters());c=this._sServiceUrl+"/"+p.getResourceType()+"/_search";g="application/x-www-form-urlencoded"}else{var m=p.getQueryParameters()?"":this._buildQueryParameters(s,_,e);c=r.startsWith("http")?r:this._sServiceUrl+p.getRelativeUrlWithQueryParameters()+m}i=i?i:{};i["Accept-Language"]=sap.ui.getCore().getConfiguration().getLanguageTag();i["cache-control"]="no-cache";i.Prefer=this.sPrefer;var y=function(){return this._ajax(f,{url:c,data:g=="application/json"?JSON.stringify(n):n,beforeSend:function(e,r){f.setUrl(r.url);f.setData(r.data);f.setRequest(e);f.setHeaders(r.headers);var s=[];if(r.url!==this._sServiceUrl){s=t.filterArray(this._aPendingRequestHandles,undefined,undefined,function(e){return e.getUrl()===r.url})}if(s.length>0){this._add(s[0],o,d);e.abort()}else{this.oModel.fireRequestSent(this._createEventParameters(f))}}.bind(this),headers:i,type:e,contentType:g,traditional:true},o,d)}.bind(this);if(this._isCsrfTokenRequest()){i["x-csrf-token"]="fetch";var R=t.deepClone(o);var v=t.deepClone(d);o=this._callBackForXcsrfToken.bind(this,R);d=function(e,t){v(e,t)};return y()}else if(this.bCSRF&&this.sToken){i["x-csrf-token"]=this.sToken;return y()}else{return y()}};p.prototype._callBackForXcsrfToken=function(e,t){this.sToken=this.getResponseHeaders(t.getRequest())["x-csrf-token"];e(t)};p.prototype._ajax=function(t,r,s,i){var n=e.ajax(r);if(!t.isAborted()){n.complete(function(e){this.oModel.fireRequestCompleted(this._createEventParameters(e))}.bind(this,t));this._add(t,s,i);this._aPendingRequestHandles.push(t)}return t};p.prototype._add=function(e,t,r){var s=e.getRequest();s.done(function(e){this._deleteRequestHandle(e);t(e)}.bind(this,e));s.fail(function(e){this._deleteRequestHandle(e);r(e);if(!e.isAborted()){this.oModel.fireRequestFailed(this._createEventParameters(e))}}.bind(this,e))};p.prototype._createEventParameters=function(e){return{requestHandle:e}};p.prototype._getGroupSubmitMode=function(e){return this.oModel.getGroupProperty(e,"submit")};p.prototype._getGroupUri=function(e){return this.oModel.getGroupProperty(e,"uri")};p.prototype._getBundleByGroup=function(e){var t=this._mBundleQueue[e];if(!t){t=new s(this._getBundleTypeBySubmitMode(this._getGroupSubmitMode(e)),e)}else if(t instanceof u){t=t.getBundle()}return t};p.prototype._getBundleTypeBySubmitMode=function(e){switch(e){case r.Batch:return o.Batch;case r.Transaction:return o.Transaction;default:throw new Error("Unsupported SubmitMode: "+e)}};p.prototype._deleteBundleFromQueue=function(e){delete this._mBundleQueue[e]};p.prototype._buildQueryParameters=function(e,t,r){var s;r=r?r:a.GET;e=e?e:{};if(!t){return""}if(!t.getResourceId()&&r===a.GET){e=h(e,this.oDefaultQueryParams)}if(!this._isFormatSupported(e._format)){e._format="json"}s=[];d(e,function(e,t){if(t&&Array.isArray(t)){t.forEach(function(t){s.push(this._encodePair(e,t))}.bind(this))}else if(t){s.push(this._encodePair(e,t))}}.bind(this));return"?"+s.join("&")};p.prototype._encodePair=function(e,t){return this._encode(e,true)+"="+this._encode(t,false)};p.prototype._encode=function(e,t){var r=encodeURI(e).replace(this._oRegex.rAmpersand,"%26").replace(this._oRegex.rHash,"%23").replace(this._oRegex.rPlus,"%2B");if(t){r=r.replace(this._oRegex.rEquals,"%3D")}return r};p.prototype._deleteRequestHandle=function(e){var r=t.getIndexOfValueInArray(e,this._aPendingRequestHandles);this._aPendingRequestHandles.splice(r,1)};p.prototype.destroy=function(){this._mBundleQueue={};for(var e=0;e<this._aPendingRequestHandles.length;e+=0){this._aPendingRequestHandles[e].abort()}};p.prototype.getResponseHeaders=function(e){var t={};var r=e.getAllResponseHeaders().trim();var s=r.split("\n");for(var i=0;i<s.length;i++){var n=s[i];var o=n.split(":");t[o[0]]=e.getResponseHeader(o[0])}return t};p.prototype._isFormatSupported=function(e){var t=["json","application/json","application/fhir+json"];return t.indexOf(e)>=0};p.prototype._getFormData=function(e,t,r){e=e?e:{};if(r){e=h(e,r)}if(!this._isFormatSupported(e._format)){e._format="json"}if(!t){return e}if(!t.getResourceId()){e=h(e,this.oDefaultQueryParams)}return e};p.prototype._isCsrfTokenRequest=function(){return this.bCSRF?!this.sToken:false};p.prototype._isRequestTransformable=function(e,t){return e==a.GET&&this.oModel.isSecureSearchModeEnabled()&&t.isSearchAtBaseLevel()&&!this._isCsrfTokenRequest()};return p});