/*!
 * SAP SE
 * (c) Copyright 2009-2024 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/fhir/model/r4/FHIRUtils","sap/fhir/model/r4/SubmitMode","sap/fhir/model/r4/lib/FHIRBundle","sap/fhir/model/r4/lib/FHIRBundleEntry","sap/fhir/model/r4/lib/FHIRBundleRequest","sap/fhir/model/r4/lib/FHIRBundleType","sap/fhir/model/r4/lib/RequestHandle","sap/fhir/model/r4/lib/HTTPMethod","sap/fhir/model/r4/lib/FHIRUrl","sap/base/util/each","sap/base/util/merge","sap/fhir/model/r4/lib/FHIROperationOutcome"],function(jQuery,e,t,r,s,i,n,o,u,a,d,l,h){"use strict";var f=function(e,t,r,s,i){this._mBundleQueue={};this.oModel=t;this._sServiceUrl=e;this._aPendingRequestHandles=[];this.bCSRF=!!r;this.sPrefer=s?"return=minimal":s;this.oDefaultQueryParams=i;this._oRegex={rAmpersand:/&/g,rEquals:/\=/g,rHash:/#/g,rPlus:/\+/g}};f.prototype.submitBundle=function(e,t,r){var s=this._mBundleQueue[e];return this._sendBundle(s,t,r)};f.prototype._request=function(r,s,i,n,a,d,l,h,f,p,c){if(!e.isRequestable(s)&&!i){return undefined}var g;if(!i&&this._getGroupSubmitMode(a)!==t.Direct){var _=this._getBundleByGroup(a);var m=this._getGroupUri(a);var y=this._createBundleEntry(r,s,n,l,h,f,p,m);_.addBundleEntry(y);if(c){this._mBundleQueue[a]=_;return _}else{g=this._mBundleQueue[a];if(g&&g instanceof o){g.getRequest().abort()}g=this._sendBundle(_);this._mBundleQueue[a]=g;return g}}g=this._sendRequest(r,s,n,d,r===u.PUT||r==u.POST?l:undefined,h,f,p);return g};f.prototype._createBundleEntry=function(t,r,n,o,a,d,l,h){if(r&&r.charAt(0)==="/"){r=r.slice(1)}var f=t===u.POST?this.oModel.getBindingInfo("/"+r,undefined,false,o):this.oModel.getBindingInfo("/"+r);var p=r+(u.GET===t?this._buildQueryParameters(n,f,t):"");var c;var g;if(u.GET!==t){c=e.generateFullUrl(h,f.getResourceServerPath(),f.getResourceId(),this._sServiceUrl);g=f.getETag()}var _=new i(l,t,p,a,d,g);var m;if(t==u.POST||t==u.PUT){m=new s(c,o,_)}else{m=new s(c,undefined,_)}return m};f.prototype._sendBundle=function(e,t,r){var s=function(s,i){var n=[];var o=[];this._deleteBundleFromQueue(e.getGroupId());for(var u=0;u<s.getNumberOfBundleEntries();u++){var a=s.getBundlyEntry(u);var d=i.getRequest().responseJSON.entry[u];if(d&&d.response.status.startsWith("2")){if(d.resource){n.push(d.resource)}else if(a.getResource()){n.push(a.getResource())}a.getRequest().executeSuccessCallback(i,d,a)}else{if(d&&d.response.outcome){o.push(new h(d.response.outcome))}a.getRequest().executeErrorCallback(i,d,a)}}if(r&&o.length>0){r(i,n,o)}else if(t){t(n)}}.bind(this,e);var i=function(t,s){this._deleteBundleFromQueue(e.getGroupId());for(var i=0;i<t.getNumberOfBundleEntries();i++){var n=t.getBundlyEntry(i);n.getRequest().executeErrorCallback(s)}if(r){r(s)}}.bind(this,e);var n=this._sendRequest(u.POST,"",{},{},e.getBundleData(),s,i);n.setBundle(e);return n};f.prototype._sendRequest=function(t,r,s,i,n,d,l,h){var f=new o(h);var p=new a(r,this._sServiceUrl);var c;var g="application/json";var _=this.oModel.getBindingInfo(p.getRelativeUrlWithoutQueryParameters());if(this._isRequestTransformable(t,p)){t=u.POST;n=this._getFormData(s,_,p.getQueryParameters());c=this._sServiceUrl+"/"+p.getResourceType()+"/_search";g="application/x-www-form-urlencoded"}else{var m=p.getQueryParameters()?"":this._buildQueryParameters(s,_,t);c=r.startsWith("http")?r:this._sServiceUrl+p.getRelativeUrlWithQueryParameters()+m}i=i?i:{};i["Accept-Language"]=sap.ui.getCore().getConfiguration().getLanguageTag();i["cache-control"]="no-cache";i.Prefer=this.sPrefer;var y=function(){return this._ajax(f,{url:c,data:g=="application/json"?JSON.stringify(n):n,beforeSend:function(t,r){f.setUrl(r.url);f.setData(r.data);f.setRequest(t);f.setHeaders(r.headers);var s=[];if(r.url!==this._sServiceUrl){s=e.filterArray(this._aPendingRequestHandles,undefined,undefined,function(e){return e.getUrl()===r.url})}if(s.length>0){this._add(s[0],d,l);t.abort()}else{this.oModel.fireRequestSent(this._createEventParameters(f))}}.bind(this),headers:i,type:t,contentType:g,traditional:true},d,l)}.bind(this);if(this._isCsrfTokenRequest()){i["x-csrf-token"]="fetch";var R=e.deepClone(d);var v=e.deepClone(l);d=this._callBackForXcsrfToken.bind(this,R);l=function(e,t){v(e,t)};return y()}else if(this.bCSRF&&this.sToken){i["x-csrf-token"]=this.sToken;return y()}else{return y()}};f.prototype._callBackForXcsrfToken=function(e,t){this.sToken=this.getResponseHeaders(t.getRequest())["x-csrf-token"];e(t)};f.prototype._ajax=function(e,t,r,s){var i=jQuery.ajax(t);if(!e.isAborted()){i.always(function(e){}.bind(this,e));this._add(e,r,s);this._aPendingRequestHandles.push(e)}return e};f.prototype._add=function(e,t,r){var s=e.getRequest();s.done(function(e){this._deleteRequestHandle(e);t(e);if(!e.isAborted()){this.oModel.fireRequestCompleted(this._createEventParameters(e))}}.bind(this,e));s.fail(function(e){this._deleteRequestHandle(e);r(e);if(!e.isAborted()){this.oModel.fireRequestFailed(this._createEventParameters(e));this.oModel.fireRequestCompleted(this._createEventParameters(e))}}.bind(this,e))};f.prototype._createEventParameters=function(e){return{requestHandle:e}};f.prototype._getGroupSubmitMode=function(e){return this.oModel.getGroupProperty(e,"submit")};f.prototype._getGroupUri=function(e){return this.oModel.getGroupProperty(e,"uri")};f.prototype._getBundleByGroup=function(e){var t=this._mBundleQueue[e];if(!t){t=new r(this._getBundleTypeBySubmitMode(this._getGroupSubmitMode(e)),e)}else if(t instanceof o){t=t.getBundle()}return t};f.prototype._getBundleTypeBySubmitMode=function(e){switch(e){case t.Batch:return n.Batch;case t.Transaction:return n.Transaction;default:throw new Error("Unsupported SubmitMode: "+e)}};f.prototype._deleteBundleFromQueue=function(e){delete this._mBundleQueue[e]};f.prototype._buildQueryParameters=function(e,t,r){var s;r=r?r:u.GET;e=e?e:{};if(!t){return""}if(!t.getResourceId()&&r===u.GET){e=l(e,this.oDefaultQueryParams)}if(!this._isFormatSupported(e._format)&&r!==u.DELETE){e._format="json"}s=[];d(e,function(e,t){if(t&&Array.isArray(t)){t.forEach(function(t){s.push(this._encodePair(e,t))}.bind(this))}else if(t){s.push(this._encodePair(e,t))}}.bind(this));return s.length>0?"?"+s.join("&"):""};f.prototype._encodePair=function(e,t){return this._encode(e,true)+"="+this._encode(t,false)};f.prototype._encode=function(e,t){var r=encodeURI(e).replace(this._oRegex.rAmpersand,"%26").replace(this._oRegex.rHash,"%23").replace(this._oRegex.rPlus,"%2B");if(t){r=r.replace(this._oRegex.rEquals,"%3D")}return r};f.prototype._deleteRequestHandle=function(t){var r=e.getIndexOfValueInArray(t,this._aPendingRequestHandles);this._aPendingRequestHandles.splice(r,1)};f.prototype.destroy=function(){this._mBundleQueue={};for(var e=0;e<this._aPendingRequestHandles.length;e+=0){this._aPendingRequestHandles[e].abort()}};f.prototype.getResponseHeaders=function(e){var t={};var r=e.getAllResponseHeaders().trim();var s=r.split("\n");for(var i=0;i<s.length;i++){var n=s[i];var o=n.split(":");t[o[0]]=e.getResponseHeader(o[0])}return t};f.prototype._isFormatSupported=function(e){var t=["json","application/json","application/fhir+json"];return t.indexOf(e)>=0};f.prototype._getFormData=function(e,t,r){e=e?e:{};if(r){e=l(e,r)}if(!this._isFormatSupported(e._format)){e._format="json"}if(!t){return e}if(!t.getResourceId()){e=l(e,this.oDefaultQueryParams)}return e};f.prototype._isCsrfTokenRequest=function(){return this.bCSRF?!this.sToken:false};f.prototype._isRequestTransformable=function(e,t){return e==u.GET&&this.oModel.isSecureSearchModeEnabled()&&t.isSearchAtBaseLevel()&&!this._isCsrfTokenRequest()&&!t.isMetadataRequest()};return f});
//# sourceMappingURL=FHIRRequestor.js.map